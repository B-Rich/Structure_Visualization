/*! simple_ui_all.js
 * contains the following files: Detector.js, CanvasRenderer.js, TrackballControls.js, OrthographicTrackballControls.js, Projector.js, icn3d.js, simple_ui.js
 */
/*! Detector.js
 * @author alteredq / http://alteredqualia.com/
 * @author mr.doob / http://mrdoob.com/
 */
var Detector={canvas:!!window.CanvasRenderingContext2D,webgl:(function(){try{var a=document.createElement("canvas");return !!(window.WebGLRenderingContext&&(a.getContext("webgl")||a.getContext("experimental-webgl")))}catch(b){return false}})(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var a=document.createElement("div");a.id="webgl-error-message";a.style.fontFamily="monospace";a.style.fontSize="13px";a.style.fontWeight="normal";a.style.textAlign="center";a.style.background="#fff";a.style.color="#000";a.style.padding="1.5em";a.style.width="400px";a.style.margin="5em auto 0";if(!this.webgl){a.innerHTML=window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n"):['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n")}return a},addGetWebGLMessage:function(c){var b,d,a;c=c||{};b=c.parent!==undefined?c.parent:document.body;d=c.id!==undefined?c.id:"oldie";a=Detector.getWebGLErrorMessage();a.id=d;b.appendChild(a)}};if(typeof module==="object"){module.exports=Detector;
/*! CanvasRenderer.js
 * @author mrdoob / http://mrdoob.com/
 */
}THREE.SpriteCanvasMaterial=function(a){THREE.Material.call(this);this.type="SpriteCanvasMaterial";this.color=new THREE.Color(16777215);this.program=function(c,b){};this.setValues(a)};THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype);THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial;THREE.SpriteCanvasMaterial.prototype.clone=function(){var a=new THREE.SpriteCanvasMaterial();a.copy(this);a.color.copy(this.color);a.program=this.program;return a};THREE.CanvasRenderer=function(H){var aE=THREE.Math.smoothstep;H=H||{};var z=this,E,J,n,a=new THREE.Projector(),j=H.canvas!==undefined?H.canvas:document.createElement("canvas"),C=j.width,aD=j.height,al=Math.floor(C/2),M=Math.floor(aD/2),c=0,b=0,aG=C,B=aD,p=1,g=j.getContext("2d",{alpha:H.alpha===true}),K=new THREE.Color(0),az=H.alpha===true?0:1,aF=1,aB=0,A=null,aA=null,O=null,l=null,aw=null,T=[],aN,ak,aj,ah,ag,af=new THREE.RenderableVertex(),ad=new THREE.RenderableVertex(),y,x,f,d,aM,aK,ay,ax,Y,W,S,Q,h=new THREE.Color(),u=new THREE.Color(),t=new THREE.Color(),r=new THREE.Color(),q=new THREE.Color(),ab=new THREE.Color(),v=new THREE.Color(),at=new THREE.Color(),L={},ac,k,aL,aI,av,ar,X,V,aP=new THREE.Box2(),w=new THREE.Box2(),D=new THREE.Box2(),aH=new THREE.Color(),G=new THREE.Color(),ai=new THREE.Color(),m=new THREE.Vector3(),aQ=new THREE.Vector3(),aa=new THREE.Vector3(),R=new THREE.Matrix3();if(g.setLineDash===undefined){g.setLineDash=function(){}}this.domElement=j;this.autoClear=true;this.sortObjects=true;this.sortElements=true;this.info={render:{vertices:0,faces:0}};this.supportsVertexTextures=function(){};this.setFaceCulling=function(){};this.getContext=function(){return g};this.getContextAttributes=function(){return g.getContextAttributes()};this.getPixelRatio=function(){return p};this.setPixelRatio=function(aS){if(aS!==undefined){p=aS}};this.setSize=function(aT,aS,aU){C=aT*p;aD=aS*p;j.width=C;j.height=aD;al=Math.floor(C/2);M=Math.floor(aD/2);if(aU!==false){j.style.width=aT+"px";j.style.height=aS+"px"}aP.min.set(-al,-M);aP.max.set(al,M);w.min.set(-al,-M);w.max.set(al,M);aF=1;aB=0;A=null;aA=null;O=null;l=null;aw=null;this.setViewport(0,0,aT,aS)};this.setViewport=function(aT,aV,aU,aS){c=aT*p;b=aV*p;aG=aU*p;B=aS*p};this.setScissor=function(){};this.enableScissorTest=function(){};this.setClearColor=function(aS,aT){K.set(aS);az=aT!==undefined?aT:1;w.min.set(-al,-M);w.max.set(al,M)};this.setClearColorHex=function(aS,aT){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead.");this.setClearColor(aS,aT)};this.getClearColor=function(){return K};this.getClearAlpha=function(){return az};this.getMaxAnisotropy=function(){return 0};this.clear=function(){if(w.empty()===false){w.intersect(aP);w.expandByScalar(2);w.min.x=w.min.x+al;w.min.y=-w.min.y+M;w.max.x=w.max.x+al;w.max.y=-w.max.y+M;if(az<1){g.clearRect(w.min.x|0,w.max.y|0,(w.max.x-w.min.x)|0,(w.min.y-w.max.y)|0)}if(az>0){ao(THREE.NormalBlending);F(1);am("rgba("+Math.floor(K.r*255)+","+Math.floor(K.g*255)+","+Math.floor(K.b*255)+","+az+")");g.fillRect(w.min.x|0,w.max.y|0,(w.max.x-w.min.x)|0,(w.min.y-w.max.y)|0)}w.makeEmpty()}};this.clearColor=function(){};this.clearDepth=function(){};this.clearStencil=function(){};this.render=function(aX,aV){if(aV instanceof THREE.Camera===false){console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");return}if(this.autoClear===true){this.clear()}z.info.render.vertices=0;z.info.render.faces=0;g.setTransform(aG/C,0,0,-B/aD,c,aD-b);g.translate(al,M);E=a.projectScene(aX,aV,this.sortObjects,this.sortElements);J=E.elements;n=E.lights;aN=aV;R.getNormalMatrix(aV.matrixWorldInverse);aq();for(var aW=0,aU=J.length;aW<aU;aW++){var aS=J[aW];var aT=aS.material;if(aT===undefined||aT.opacity===0){continue}D.makeEmpty();if(aS instanceof THREE.RenderableSprite){ak=aS;ak.x*=al;ak.y*=M;o(ak,aS,aT)}else{if(aS instanceof THREE.RenderableLine){ak=aS.v1;aj=aS.v2;ak.positionScreen.x*=al;ak.positionScreen.y*=M;aj.positionScreen.x*=al;aj.positionScreen.y*=M;D.setFromPoints([ak.positionScreen,aj.positionScreen]);if(aP.isIntersectionBox(D)===true){au(ak,aj,aS,aT)}}else{if(aS instanceof THREE.RenderableFace){ak=aS.v1;aj=aS.v2;ah=aS.v3;if(ak.positionScreen.z<-1||ak.positionScreen.z>1){continue}if(aj.positionScreen.z<-1||aj.positionScreen.z>1){continue}if(ah.positionScreen.z<-1||ah.positionScreen.z>1){continue}ak.positionScreen.x*=al;ak.positionScreen.y*=M;aj.positionScreen.x*=al;aj.positionScreen.y*=M;ah.positionScreen.x*=al;ah.positionScreen.y*=M;if(aT.overdraw>0){an(ak.positionScreen,aj.positionScreen,aT.overdraw);an(aj.positionScreen,ah.positionScreen,aT.overdraw);an(ah.positionScreen,ak.positionScreen,aT.overdraw)}D.setFromPoints([ak.positionScreen,aj.positionScreen,ah.positionScreen]);if(aP.isIntersectionBox(D)===true){aR(ak,aj,ah,0,1,2,aS,aT)}}}}w.union(D)}g.setTransform(1,0,0,1,0,0)};function aq(){aH.setRGB(0,0,0);G.setRGB(0,0,0);ai.setRGB(0,0,0);for(var aU=0,aV=n.length;aU<aV;aU++){var aT=n[aU];var aS=aT.color;if(aT instanceof THREE.AmbientLight){aH.add(aS)}else{if(aT instanceof THREE.DirectionalLight){G.add(aS)}else{if(aT instanceof THREE.PointLight){ai.add(aS)}}}}}function e(aS,aZ,aW){for(var aV=0,aY=n.length;aV<aY;aV++){var aU=n[aV];at.copy(aU.color);if(aU instanceof THREE.DirectionalLight){var aT=m.setFromMatrixPosition(aU.matrixWorld).normalize();var aX=aZ.dot(aT);if(aX<=0){continue}aX*=aU.intensity;aW.add(at.multiplyScalar(aX))}else{if(aU instanceof THREE.PointLight){var aT=m.setFromMatrixPosition(aU.matrixWorld);var aX=aZ.dot(m.subVectors(aT,aS).normalize());if(aX<=0){continue}aX*=aU.distance==0?1:1-Math.min(aS.distanceTo(aT)/aU.distance,1);if(aX==0){continue}aX*=aU.intensity;aW.add(at.multiplyScalar(aX))}}}}function o(a4,aW,aX){F(aX.opacity);ao(aX.blending);var a6=aW.scale.x*al;var a5=aW.scale.y*M;var a0=0.5*Math.sqrt(a6*a6+a5*a5);D.min.set(a4.x-a0,a4.y-a0);D.max.set(a4.x+a0,a4.y+a0);if(aX instanceof THREE.SpriteMaterial){var aZ=aX.map;if(aZ!==null){var aY=L[aZ.id];if(aY===undefined||aY.version!==aZ.version){aY=P(aZ);L[aZ.id]=aY}if(aY.canvas!==undefined){am(aY.canvas);var a3=aZ.image;var aT=a3.width*aZ.offset.x;var aS=a3.height*aZ.offset.y;var a2=a3.width*aZ.repeat.x;var a1=a3.height*aZ.repeat.y;var aV=a6/a2;var aU=a5/a1;g.save();g.translate(a4.x,a4.y);if(aX.rotation!==0){g.rotate(aX.rotation)}g.translate(-a6/2,-a5/2);g.scale(aV,aU);g.translate(-aT,-aS);g.fillRect(aT,aS,a2,a1);g.restore()}}else{am(aX.color.getStyle());g.save();g.translate(a4.x,a4.y);if(aX.rotation!==0){g.rotate(aX.rotation)}g.scale(a6,-a5);g.fillRect(-0.5,-0.5,1,1);g.restore()}}else{if(aX instanceof THREE.SpriteCanvasMaterial){aC(aX.color.getStyle());am(aX.color.getStyle());g.save();g.translate(a4.x,a4.y);if(aX.rotation!==0){g.rotate(aX.rotation)}g.scale(a6,a5);aX.program(g);g.restore()}}}function au(aZ,aX,aV,aW){F(aW.opacity);ao(aW.blending);g.beginPath();g.moveTo(aZ.positionScreen.x,aZ.positionScreen.y);g.lineTo(aX.positionScreen.x,aX.positionScreen.y);if(aW instanceof THREE.LineBasicMaterial){N(aW.linewidth);ae(aW.linecap);aJ(aW.linejoin);if(aW.vertexColors!==THREE.VertexColors){aC(aW.color.getStyle())}else{var aU=aV.vertexColors[0].getStyle();var aS=aV.vertexColors[1].getStyle();if(aU===aS){aC(aU)}else{try{var aY=g.createLinearGradient(aZ.positionScreen.x,aZ.positionScreen.y,aX.positionScreen.x,aX.positionScreen.y);aY.addColorStop(0,aU);aY.addColorStop(1,aS)}catch(aT){aY=aU}aC(aY)}}g.stroke();D.expandByScalar(aW.linewidth*2)}else{if(aW instanceof THREE.LineDashedMaterial){N(aW.linewidth);ae(aW.linecap);aJ(aW.linejoin);aC(aW.color.getStyle());Z([aW.dashSize,aW.gapSize]);g.stroke();D.expandByScalar(aW.linewidth*2);Z([])}}}function aR(a0,aZ,aY,aV,aU,aT,aW,aX){z.info.render.vertices+=3;z.info.render.faces++;F(aX.opacity);ao(aX.blending);y=a0.positionScreen.x;x=a0.positionScreen.y;f=aZ.positionScreen.x;d=aZ.positionScreen.y;aM=aY.positionScreen.x;aK=aY.positionScreen.y;U(y,x,f,d,aM,aK);if((aX instanceof THREE.MeshLambertMaterial||aX instanceof THREE.MeshPhongMaterial)&&aX.map===null){ab.copy(aX.color);v.copy(aX.emissive);if(aX.vertexColors===THREE.FaceColors){ab.multiply(aW.color)}h.copy(aH);aQ.copy(a0.positionWorld).add(aZ.positionWorld).add(aY.positionWorld).divideScalar(3);e(aQ,aW.normalModel,h);h.multiply(ab).add(v);aX.wireframe===true?aO(h,aX.wireframeLinewidth,aX.wireframeLinecap,aX.wireframeLinejoin):i(h)}else{if(aX instanceof THREE.MeshBasicMaterial||aX instanceof THREE.MeshLambertMaterial||aX instanceof THREE.MeshPhongMaterial){if(aX.map!==null){var aS=aX.map.mapping;if(aS===THREE.UVMapping){k=aW.uvs;ap(y,x,f,d,aM,aK,k[aV].x,k[aV].y,k[aU].x,k[aU].y,k[aT].x,k[aT].y,aX.map)}}else{if(aX.envMap!==null){if(aX.envMap.mapping===THREE.SphericalReflectionMapping){aa.copy(aW.vertexNormalsModel[aV]).applyMatrix3(R);aL=0.5*aa.x+0.5;aI=0.5*aa.y+0.5;aa.copy(aW.vertexNormalsModel[aU]).applyMatrix3(R);av=0.5*aa.x+0.5;ar=0.5*aa.y+0.5;aa.copy(aW.vertexNormalsModel[aT]).applyMatrix3(R);X=0.5*aa.x+0.5;V=0.5*aa.y+0.5;ap(y,x,f,d,aM,aK,aL,aI,av,ar,X,V,aX.envMap)}}else{h.copy(aX.color);if(aX.vertexColors===THREE.FaceColors){h.multiply(aW.color)}aX.wireframe===true?aO(h,aX.wireframeLinewidth,aX.wireframeLinecap,aX.wireframeLinejoin):i(h)}}}else{if(aX instanceof THREE.MeshDepthMaterial){h.r=h.g=h.b=1-aE(a0.positionScreen.z*a0.positionScreen.w,aN.near,aN.far);aX.wireframe===true?aO(h,aX.wireframeLinewidth,aX.wireframeLinecap,aX.wireframeLinejoin):i(h)}else{if(aX instanceof THREE.MeshNormalMaterial){aa.copy(aW.normalModel).applyMatrix3(R);h.setRGB(aa.x,aa.y,aa.z).multiplyScalar(0.5).addScalar(0.5);aX.wireframe===true?aO(h,aX.wireframeLinewidth,aX.wireframeLinecap,aX.wireframeLinejoin):i(h)}else{h.setRGB(1,1,1);aX.wireframe===true?aO(h,aX.wireframeLinewidth,aX.wireframeLinecap,aX.wireframeLinejoin):i(h)}}}}}function U(aV,aX,aT,aW,aS,aU){g.beginPath();g.moveTo(aV,aX);g.lineTo(aT,aW);g.lineTo(aS,aU);g.closePath()}function aO(aS,aV,aU,aT){N(aV);ae(aU);aJ(aT);aC(aS.getStyle());g.stroke();D.expandByScalar(aV*2)}function i(aS){am(aS.getStyle());g.fill()}function P(aW){if(aW.version===0||aW instanceof THREE.CompressedTexture||aW instanceof THREE.DataTexture){return{canvas:undefined,version:aW.version}}var aY=aW.image;var aS=document.createElement("canvas");aS.width=aY.width;aS.height=aY.height;var aT=aS.getContext("2d");aT.setTransform(1,0,0,-1,0,aY.height);aT.drawImage(aY,0,0);var aV=aW.wrapS===THREE.RepeatWrapping;var aU=aW.wrapT===THREE.RepeatWrapping;var aX="no-repeat";if(aV===true&&aU===true){aX="repeat"}else{if(aV===true){aX="repeat-x"}else{if(aU===true){aX="repeat-y"}}}return{canvas:g.createPattern(aS,aX),version:aW.version}}function ap(ba,aX,a7,aW,a4,aU,a6,aV,a3,aT,a2,aS,aZ){var a5=L[aZ.id];if(a5===undefined||a5.version!==aZ.version){a5=P(aZ);L[aZ.id]=a5}if(a5.canvas!==undefined){am(a5.canvas)}else{am("rgba( 0, 0, 0, 1)");g.fill();return}var bh,bg,bf,be,bc,a9,aY,bd,bb=aZ.offset.x/aZ.repeat.x,a8=aZ.offset.y/aZ.repeat.y,a1=aZ.image.width*aZ.repeat.x,a0=aZ.image.height*aZ.repeat.y;a6=(a6+bb)*a1;aV=(aV+a8)*a0;a3=(a3+bb)*a1;aT=(aT+a8)*a0;a2=(a2+bb)*a1;aS=(aS+a8)*a0;a7-=ba;aW-=aX;a4-=ba;aU-=aX;a3-=a6;aT-=aV;a2-=a6;aS-=aV;aY=a3*aS-a2*aT;if(aY===0){return}bd=1/aY;bh=(aS*a7-aT*a4)*bd;bg=(aS*aW-aT*aU)*bd;bf=(a3*a4-a2*a7)*bd;be=(a3*aU-a2*aW)*bd;bc=ba-bh*a6-bf*aV;a9=aX-bg*a6-be*aV;g.save();g.transform(bh,bg,bf,be,bc,a9);g.fill();g.restore()}function I(a8,aX,a6,aW,a4,aU,a5,aV,a3,aT,a2,aS,a0){var be,bd,bc,bb,a9,a7,aY,ba,a1=a0.width-1,aZ=a0.height-1;a5*=a1;aV*=aZ;a3*=a1;aT*=aZ;a2*=a1;aS*=aZ;a6-=a8;aW-=aX;a4-=a8;aU-=aX;a3-=a5;aT-=aV;a2-=a5;aS-=aV;aY=a3*aS-a2*aT;ba=1/aY;be=(aS*a6-aT*a4)*ba;bd=(aS*aW-aT*aU)*ba;bc=(a3*a4-a2*a6)*ba;bb=(a3*aU-a2*aW)*ba;a9=a8-be*a5-bc*aV;a7=aX-bd*a5-bb*aV;g.save();g.transform(be,bd,bc,bb,a9,a7);g.clip();g.drawImage(a0,0,0);g.restore()}function an(aY,aV,aX){var aS=aV.x-aY.x,aW=aV.y-aY.y,aT=aS*aS+aW*aW,aU;if(aT===0){return}aU=aX/Math.sqrt(aT);aS*=aU;aW*=aU;aV.x+=aS;aV.y+=aW;aY.x-=aS;aY.y-=aW}function F(aS){if(aF!==aS){g.globalAlpha=aS;aF=aS}}function ao(aS){if(aB!==aS){if(aS===THREE.NormalBlending){g.globalCompositeOperation="source-over"}else{if(aS===THREE.AdditiveBlending){g.globalCompositeOperation="lighter"}else{if(aS===THREE.SubtractiveBlending){g.globalCompositeOperation="darker"}}}aB=aS}}function N(aS){if(O!==aS){g.lineWidth=aS;O=aS}}function ae(aS){if(l!==aS){g.lineCap=aS;l=aS}}function aJ(aS){if(aw!==aS){g.lineJoin=aS;aw=aS}}function aC(aS){if(A!==aS){g.strokeStyle=aS;A=aS}}function am(aS){if(aA!==aS){g.fillStyle=aS;aA=aS}}function Z(aS){if(T.length!==aS.length){g.setLineDash(aS);T=aS}}};
/*! TrackballControls.js from three.js
 * @author Eberhard Graether / http://egraether.com/
 * @author Mark Lundin  / http://mark-lundin.com
 */
THREE.TrackballControls=function(y,x,j){var r=this;this.STATE={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4};this.object=y;this.domElement=(x!==undefined)?x:document;this.enabled=true;this.screen={left:0,top:0,width:0,height:0};this.rotateSpeed=1;this.zoomSpeed=1.2;this.panSpeed=0.3;this.noRotate=false;this.noZoom=false;this.noPan=false;this.noRoll=false;this.staticMoving=false;this.dynamicDampingFactor=0.2;this.minDistance=0;this.maxDistance=Infinity;this.keys=[65,83,68];this.target=new THREE.Vector3();var l=0.000001;var k=new THREE.Vector3();this._state=this.STATE.NONE;var m=this.STATE.NONE;var a=new THREE.Vector3();this._rotateStart=new THREE.Vector3();this._rotateEnd=new THREE.Vector3();this._zoomStart=new THREE.Vector2();this._zoomEnd=new THREE.Vector2();var h=0;var d=0;this._panStart=new THREE.Vector2();this._panEnd=new THREE.Vector2();this.target0=this.target.clone();this.position0=this.object.position.clone();this.up0=this.object.up.clone();var w={type:"change"};var n={type:"start"};var g={type:"end"};this.handleResize=function(){if(this.domElement===document){this.screen.left=0;this.screen.top=0;this.screen.width=window.innerWidth;this.screen.height=window.innerHeight}else{var z=this.domElement.getBoundingClientRect();var A=this.domElement.ownerDocument.documentElement;this.screen.left=z.left+window.pageXOffset-A.clientLeft;this.screen.top=z.top+window.pageYOffset-A.clientTop;this.screen.width=z.width;this.screen.height=z.height}};this.handleEvent=function(z){if(typeof this[z.type]==="function"){this[z.type](z)}};var c=(function(){var z=new THREE.Vector2();return function(B,A){z.set((B-r.screen.left)/r.screen.width,(A-r.screen.top)/r.screen.height);return z}}());var b=(function(){var A=new THREE.Vector3();var z=new THREE.Vector3();var B=new THREE.Vector3();return function(D,C){B.set((D-r.screen.width*0.5-r.screen.left)/(r.screen.width*0.5),(r.screen.height*0.5+r.screen.top-C)/(r.screen.height*0.5),0);var E=B.length();if(r.noRoll){if(E<Math.SQRT1_2){B.z=Math.sqrt(1-E*E)}else{B.z=0.5/E}}else{if(E>1){B.normalize()}else{B.z=Math.sqrt(1-E*E)}}a.copy(r.object.position).sub(r.target);A.copy(r.object.up).setLength(B.y);A.add(z.copy(r.object.up).cross(a).setLength(B.x));A.add(a.setLength(B.z));return A}}());this.rotateCamera=(function(B,C){var z=new THREE.Vector3(),A=new THREE.Quaternion();return function(E,F){var D;if(E===undefined){D=Math.acos(r._rotateStart.dot(r._rotateEnd)/r._rotateStart.length()/r._rotateEnd.length())}if(D||E!==undefined){if(E===undefined){z.crossVectors(r._rotateStart,r._rotateEnd).normalize();D*=r.rotateSpeed;A.setFromAxisAngle(z,-D)}else{A.copy(E)}if(F===undefined||F===true){j.quaternion.multiplyQuaternions(A,j.quaternion)}a.applyQuaternion(A);r.object.up.applyQuaternion(A);r._rotateEnd.applyQuaternion(A);if(r.staticMoving){r._rotateStart.copy(r._rotateEnd)}else{A.setFromAxisAngle(z,D*(r.dynamicDampingFactor-1));r._rotateStart.applyQuaternion(A)}}}}());this.zoomCamera=function(A,B){if(r._state===r.STATE.TOUCH_ZOOM_PAN){var z;if(A!==undefined){z=A}else{z=h/d;h=d}a.multiplyScalar(z);if(B===undefined||B===true){j._zoomFactor*=z}}else{var z;if(A!==undefined){z=A}else{z=1+(r._zoomEnd.y-r._zoomStart.y)*r.zoomSpeed}if(B===undefined||B===true){j._zoomFactor*=z}if(z!==1){a.multiplyScalar(z);if(r.staticMoving){r._zoomStart.copy(r._zoomEnd)}else{r._zoomStart.y+=(r._zoomEnd.y-r._zoomStart.y)*this.dynamicDampingFactor}}}};this.panCamera=(function(A,D){var B=new THREE.Vector2(),z=new THREE.Vector3(),C=new THREE.Vector3();return function(E,F){if(E!==undefined){B=E;if(F===undefined||F===true){j.mouseChange.add(E)}}else{B.copy(r._panEnd).sub(r._panStart);if(F===undefined||F===true){j.mouseChange.add(r._panEnd).sub(r._panStart)}}if(B.lengthSq()){B.multiplyScalar(a.length()*r.panSpeed);C.copy(a).cross(r.object.up).setLength(B.x);C.add(z.copy(r.object.up).setLength(B.y));r.object.position.add(C);r.target.add(C);if(r.staticMoving){r._panStart.copy(r._panEnd)}else{r._panStart.add(B.subVectors(r._panEnd,r._panStart).multiplyScalar(r.dynamicDampingFactor))}}}}());this.checkDistances=function(){if(!r.noZoom||!r.noPan){if(a.lengthSq()>r.maxDistance*r.maxDistance){r.object.position.addVectors(r.target,a.setLength(r.maxDistance))}if(a.lengthSq()<r.minDistance*r.minDistance){r.object.position.addVectors(r.target,a.setLength(r.minDistance))}}};this.update=function(z){a.subVectors(r.object.position,r.target);if(!r.noRotate){if(z!==undefined&&z.quaternion!==undefined){r.rotateCamera(z.quaternion,z.update)}else{r.rotateCamera()}}if(!r.noZoom){if(z!==undefined&&z._zoomFactor!==undefined){r.zoomCamera(z._zoomFactor,z.update)}else{r.zoomCamera()}}if(!r.noPan){if(z!==undefined&&z.mouseChange!==undefined){r.panCamera(z.mouseChange,z.update)}else{r.panCamera()}}r.object.position.addVectors(r.target,a);r.checkDistances();r.object.lookAt(r.target);if(k.distanceToSquared(r.object.position)>l){r.dispatchEvent(w);k.copy(r.object.position)}};this.reset=function(){r._state=r.STATE.NONE;m=r.STATE.NONE;r.target.copy(r.target0);r.object.position.copy(r.position0);r.object.up.copy(r.up0);a.subVectors(r.object.position,r.target);r.object.lookAt(r.target);r.dispatchEvent(w);k.copy(r.object.position)};function i(z){if(r.enabled===false){return}window.removeEventListener("keydown",i);m=r._state;if(r._state!==r.STATE.NONE){return}else{if(z.keyCode===r.keys[r.STATE.ROTATE]&&!r.noRotate){r._state=r.STATE.ROTATE}else{if((z.keyCode===r.keys[r.STATE.ZOOM]||z.shiftKey)&&!r.noZoom){r._state=r.STATE.ZOOM}else{if((z.keyCode===r.keys[r.STATE.PAN]||z.ctrlKey)&&!r.noPan){r._state=r.STATE.PAN}}}}}function e(z){if(r.enabled===false){return}r._state=m;window.addEventListener("keydown",i,false)}function p(z){if(r.enabled===false){return}z.preventDefault();z.stopPropagation();if(r._state===r.STATE.NONE){r._state=z.button}if(r._state===r.STATE.ROTATE&&!r.noRotate){r._rotateStart.copy(b(z.pageX,z.pageY));r._rotateEnd.copy(r._rotateStart)}else{if(r._state===r.STATE.ZOOM&&!r.noZoom){r._zoomStart.copy(c(z.pageX,z.pageY));r._zoomEnd.copy(r._zoomStart)}else{if(r._state===r.STATE.PAN&&!r.noPan){r._panStart.copy(c(z.pageX,z.pageY));r._panEnd.copy(r._panStart)}}}document.addEventListener("mousemove",u,false);document.addEventListener("mouseup",q,false);r.dispatchEvent(n)}function u(z){if(r.enabled===false){return}z.preventDefault();z.stopPropagation();if(r._state===r.STATE.ROTATE&&!r.noRotate){r._rotateEnd.copy(b(z.pageX,z.pageY))}else{if(r._state===r.STATE.ZOOM&&!r.noZoom){r._zoomEnd.copy(c(z.pageX,z.pageY))}else{if(r._state===r.STATE.PAN&&!r.noPan){r._panEnd.copy(c(z.pageX,z.pageY))}}}}function q(z){if(r.enabled===false){return}z.preventDefault();z.stopPropagation();r._state=r.STATE.NONE;document.removeEventListener("mousemove",u);document.removeEventListener("mouseup",q);r.dispatchEvent(g)}function o(z){if(r.enabled===false){return}z.preventDefault();z.stopPropagation();var A=0;if(z.wheelDelta){A=z.wheelDelta/40}else{if(z.detail){A=-z.detail/3}}r._zoomStart.y=A*0.01;r.dispatchEvent(n);r.dispatchEvent(g)}function t(C){if(r.enabled===false){return}switch(C.touches.length){case 1:r._state=r.STATE.TOUCH_ROTATE;r._rotateStart.copy(b(C.touches[0].pageX,C.touches[0].pageY));r._rotateEnd.copy(r._rotateStart);break;case 2:r._state=r.STATE.TOUCH_ZOOM_PAN;var B=C.touches[0].pageX-C.touches[1].pageX;var A=C.touches[0].pageY-C.touches[1].pageY;d=h=Math.sqrt(B*B+A*A);var z=(C.touches[0].pageX+C.touches[1].pageX)/2;var D=(C.touches[0].pageY+C.touches[1].pageY)/2;r._panStart.copy(c(z,D));r._panEnd.copy(r._panStart);break;default:r._state=r.STATE.NONE}r.dispatchEvent(n)}function f(C){if(r.enabled===false){return}C.preventDefault();C.stopPropagation();switch(C.touches.length){case 1:r._rotateEnd.copy(b(C.touches[0].pageX,C.touches[0].pageY));break;case 2:var B=C.touches[0].pageX-C.touches[1].pageX;var A=C.touches[0].pageY-C.touches[1].pageY;d=Math.sqrt(B*B+A*A);var z=(C.touches[0].pageX+C.touches[1].pageX)/2;var D=(C.touches[0].pageY+C.touches[1].pageY)/2;r._panEnd.copy(c(z,D));break;default:r._state=r.STATE.NONE}}function v(A){if(r.enabled===false){return}switch(A.touches.length){case 1:r._rotateEnd.copy(b(A.touches[0].pageX,A.touches[0].pageY));r._rotateStart.copy(r._rotateEnd);break;case 2:h=d=0;var z=(A.touches[0].pageX+A.touches[1].pageX)/2;var B=(A.touches[0].pageY+A.touches[1].pageY)/2;r._panEnd.copy(c(z,B));r._panStart.copy(r._panEnd);break}r._state=r.STATE.NONE;r.dispatchEvent(g)}this.domElement.addEventListener("contextmenu",function(z){z.preventDefault()},false);this.domElement.addEventListener("mousedown",p,false);this.domElement.addEventListener("mousewheel",o,false);this.domElement.addEventListener("DOMMouseScroll",o,false);this.domElement.addEventListener("touchstart",t,false);this.domElement.addEventListener("touchend",v,false);this.domElement.addEventListener("touchmove",f,false);window.addEventListener("keydown",i,false);window.addEventListener("keyup",e,false);this.handleResize();this.update()};THREE.TrackballControls.prototype=Object.create(THREE.EventDispatcher.prototype);THREE.TrackballControls.prototype.constructor=THREE.TrackballControls;
/*! OrthographicTrackballControls.js from three.js
 * @author Eberhard Graether / http://egraether.com/
 * @author Mark Lundin  / http://mark-lundin.com
 * @author Patrick Fuller / http://patrick-fuller.com
 */
THREE.OrthographicTrackballControls=function(B,z,k){var t=this;var u={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4};this.object=B;this.domElement=(z!==undefined)?z:document;this.enabled=true;this.screen={left:0,top:0,width:0,height:0};this.rotateSpeed=0.5;this.zoomSpeed=1.2;var A=0.01;this.zoomSpeed*=A;this.panSpeed=0.03;this.noRotate=false;this.noZoom=false;this.noPan=false;this.noRoll=false;this.staticMoving=false;this.dynamicDampingFactor=0.2;this.keys=[65,83,68];this.target=new THREE.Vector3();var m=0.000001;var l=new THREE.Vector3();this._state=u.NONE;var n=u.NONE;var b=new THREE.Vector3();this._rotateStart=new THREE.Vector3();this._rotateEnd=new THREE.Vector3();this._zoomStart=new THREE.Vector2();this._zoomEnd=new THREE.Vector2();var i=1;var j=0;var d=0;this._panStart=new THREE.Vector2();this._panEnd=new THREE.Vector2();this.target0=this.target.clone();this.position0=this.object.position.clone();this.up0=this.object.up.clone();this.left0=this.object.left;this.right0=this.object.right;this.top0=this.object.top;this.bottom0=this.object.bottom;this.center0=new THREE.Vector2((this.left0+this.right0)/2,(this.top0+this.bottom0)/2);var y={type:"change"};var o={type:"start"};var h={type:"end"};this.handleResize=function(){if(this.domElement===document){this.screen.left=0;this.screen.top=0;this.screen.width=window.innerWidth;this.screen.height=window.innerHeight}else{var C=this.domElement.getBoundingClientRect();var D=this.domElement.ownerDocument.documentElement;this.screen.left=C.left+window.pageXOffset-D.clientLeft;this.screen.top=C.top+window.pageYOffset-D.clientTop;this.screen.width=C.width;this.screen.height=C.height}this.left0=this.object.left;this.right0=this.object.right;this.top0=this.object.top;this.bottom0=this.object.bottom;this.center0.set((this.left0+this.right0)/2,(this.top0+this.bottom0)/2)};this.handleEvent=function(C){if(typeof this[C.type]==="function"){this[C.type](C)}};var c=(function(){var C=new THREE.Vector2();return function(E,D){C.set((E-t.screen.left)/t.screen.width,(D-t.screen.top)/t.screen.height);return C}}());var a=(function(){var D=new THREE.Vector3();var C=new THREE.Vector3();var E=new THREE.Vector3();return function(G,F){E.set((G-t.screen.width*0.5-t.screen.left)/(t.screen.width*0.5),(t.screen.height*0.5+t.screen.top-F)/(t.screen.height*0.5),0);var H=E.length();if(t.noRoll){if(H<Math.SQRT1_2){E.z=Math.sqrt(1-H*H)}else{E.z=0.5/H}}else{if(H>1){E.normalize()}else{E.z=Math.sqrt(1-H*H)}}b.copy(t.object.position).sub(t.target);D.copy(t.object.up).setLength(E.y);D.add(C.copy(t.object.up).cross(b).setLength(E.x));D.add(b.setLength(E.z));return D}}());this.rotateCamera=(function(E,F){var C=new THREE.Vector3(),D=new THREE.Quaternion();return function(H,I){var G;if(H===undefined){G=Math.acos(t._rotateStart.dot(t._rotateEnd)/t._rotateStart.length()/t._rotateEnd.length())}if(G||H!==undefined){if(H===undefined){C.crossVectors(t._rotateStart,t._rotateEnd).normalize();G*=t.rotateSpeed;D.setFromAxisAngle(C,-G)}else{D.copy(H)}if(I===undefined||I===true){k.quaternion.multiplyQuaternions(D,k.quaternion)}b.applyQuaternion(D);t.object.up.applyQuaternion(D);t._rotateEnd.applyQuaternion(D);if(t.staticMoving){t._rotateStart.copy(t._rotateEnd)}else{D.setFromAxisAngle(C,G*(t.dynamicDampingFactor-1));t._rotateStart.applyQuaternion(D)}}}}());this.zoomCamera=function(D,E){var C;if(t._state===u.TOUCH_ZOOM_PAN){if(D!==undefined){C=D}else{C=j/d;j=d}}else{if(D!==undefined){C=D}else{C=1+(t._zoomEnd.y-t._zoomStart.y)*t.zoomSpeed/A}}if(E===undefined||E===true){k._zoomFactor*=C}if(C!==1){i=C;t.object.left=i*t.left0+(1-i)*t.center0.x;t.object.right=i*t.right0+(1-i)*t.center0.x;t.object.top=i*t.top0+(1-i)*t.center0.y;t.object.bottom=i*t.bottom0+(1-i)*t.center0.y;if(t.staticMoving){t._zoomStart.copy(t._zoomEnd)}else{t._zoomStart.y+=(t._zoomEnd.y-t._zoomStart.y)*this.dynamicDampingFactor}}};this.panCamera=(function(D,G){var E=new THREE.Vector2(),C=new THREE.Vector3(),F=new THREE.Vector3();return function(H,I){if(H!==undefined){E=H;if(I===undefined||I===true){k.mouseChange.add(H)}}else{E.copy(t._panEnd).sub(t._panStart);if(I===undefined||I===true){k.mouseChange.add(t._panEnd).sub(t._panStart)}}if(E.lengthSq()){E.multiplyScalar(b.length()*t.panSpeed);F.copy(b).cross(t.object.up).setLength(E.x);F.add(C.copy(t.object.up).setLength(E.y));t.object.position.add(F);t.target.add(F);if(t.staticMoving){t._panStart.copy(t._panEnd)}else{t._panStart.add(E.subVectors(t._panEnd,t._panStart).multiplyScalar(t.dynamicDampingFactor))}}}}());this.update=function(C){b.subVectors(t.object.position,t.target);if(!t.noRotate){if(C!==undefined&&C.quaternion!==undefined){t.rotateCamera(C.quaternion,C.update)}else{t.rotateCamera()}}if(!t.noZoom){if(C!==undefined&&C._zoomFactor!==undefined){t.zoomCamera(C._zoomFactor,C.update)}else{t.zoomCamera()}t.object.updateProjectionMatrix()}if(!t.noPan){if(C!==undefined&&C.mouseChange!==undefined){t.panCamera(C.mouseChange,C.update)}else{t.panCamera()}}t.object.position.addVectors(t.target,b);t.object.lookAt(t.target);if(l.distanceToSquared(t.object.position)>m){t.dispatchEvent(y);l.copy(t.object.position)}};this.reset=function(){t._state=u.NONE;n=u.NONE;t.target.copy(t.target0);t.object.position.copy(t.position0);t.object.up.copy(t.up0);b.subVectors(t.object.position,t.target);t.object.left=t.left0;t.object.right=t.right0;t.object.top=t.top0;t.object.bottom=t.bottom0;t.object.lookAt(t.target);t.dispatchEvent(y);l.copy(t.object.position)};function g(C){if(t.enabled===false){return}window.removeEventListener("keydown",g);n=t._state;if(t._state!==u.NONE){return}else{if(C.keyCode===t.keys[u.ROTATE]&&!t.noRotate){t._state=u.ROTATE}else{if((C.keyCode===t.keys[u.ZOOM]||C.shiftKey)&&!t.noZoom){t._state=u.ZOOM}else{if((C.keyCode===t.keys[u.PAN]||C.ctrlKey)&&!t.noPan){t._state=u.PAN}}}}}function e(C){if(t.enabled===false){return}t._state=n;window.addEventListener("keydown",g,false)}function q(C){if(t.enabled===false){return}C.preventDefault();C.stopPropagation();if(t._state===u.NONE){t._state=C.button}if(t._state===u.ROTATE&&!t.noRotate){t._rotateStart.copy(a(C.pageX,C.pageY));t._rotateEnd.copy(t._rotateStart)}else{if(t._state===u.ZOOM&&!t.noZoom){t._zoomStart.copy(c(C.pageX,C.pageY));t._zoomEnd.copy(t._zoomStart)}else{if(t._state===u.PAN&&!t.noPan){t._panStart.copy(c(C.pageX,C.pageY));t._panEnd.copy(t._panStart)}}}document.addEventListener("mousemove",w,false);document.addEventListener("mouseup",r,false);t.dispatchEvent(o)}function w(C){if(t.enabled===false){return}C.preventDefault();C.stopPropagation();if(t._state===u.ROTATE&&!t.noRotate){t._rotateEnd.copy(a(C.pageX,C.pageY))}else{if(t._state===u.ZOOM&&!t.noZoom){t._zoomEnd.copy(c(C.pageX,C.pageY))}else{if(t._state===u.PAN&&!t.noPan){t._panEnd.copy(c(C.pageX,C.pageY))}}}}function r(C){if(t.enabled===false){return}C.preventDefault();C.stopPropagation();t._state=u.NONE;document.removeEventListener("mousemove",w);document.removeEventListener("mouseup",r);t.dispatchEvent(h)}function p(C){if(t.enabled===false){return}C.preventDefault();C.stopPropagation();var D=0;if(C.wheelDelta){D=C.wheelDelta/40}else{if(C.detail){D=-C.detail/3}}t._zoomStart.y=D*0.01;t.dispatchEvent(o);t.dispatchEvent(h)}function v(F){if(t.enabled===false){return}switch(F.touches.length){case 1:t._state=u.TOUCH_ROTATE;t._rotateStart.copy(a(F.touches[0].pageX,F.touches[0].pageY));t._rotateEnd.copy(t._rotateStart);break;case 2:t._state=u.TOUCH_ZOOM_PAN;var E=F.touches[0].pageX-F.touches[1].pageX;var D=F.touches[0].pageY-F.touches[1].pageY;d=j=Math.sqrt(E*E+D*D);var C=(F.touches[0].pageX+F.touches[1].pageX)/2;var G=(F.touches[0].pageY+F.touches[1].pageY)/2;t._panStart.copy(c(C,G));t._panEnd.copy(t._panStart);break;default:t._state=u.NONE}t.dispatchEvent(o)}function f(F){if(t.enabled===false){return}F.preventDefault();F.stopPropagation();switch(F.touches.length){case 1:t._rotateEnd.copy(a(F.touches[0].pageX,F.touches[0].pageY));break;case 2:var E=F.touches[0].pageX-F.touches[1].pageX;var D=F.touches[0].pageY-F.touches[1].pageY;d=Math.sqrt(E*E+D*D);var C=(F.touches[0].pageX+F.touches[1].pageX)/2;var G=(F.touches[0].pageY+F.touches[1].pageY)/2;t._panEnd.copy(c(C,G));break;default:t._state=u.NONE}}function x(D){if(t.enabled===false){return}switch(D.touches.length){case 1:t._rotateEnd.copy(a(D.touches[0].pageX,D.touches[0].pageY));t._rotateStart.copy(t._rotateEnd);break;case 2:j=d=0;var C=(D.touches[0].pageX+D.touches[1].pageX)/2;var E=(D.touches[0].pageY+D.touches[1].pageY)/2;t._panEnd.copy(c(C,E));t._panStart.copy(t._panEnd);break}t._state=u.NONE;t.dispatchEvent(h)}this.domElement.addEventListener("contextmenu",function(C){C.preventDefault()},false);this.domElement.addEventListener("mousedown",q,false);this.domElement.addEventListener("mousewheel",p,false);this.domElement.addEventListener("DOMMouseScroll",p,false);this.domElement.addEventListener("touchstart",v,false);this.domElement.addEventListener("touchend",x,false);this.domElement.addEventListener("touchmove",f,false);window.addEventListener("keydown",g,false);window.addEventListener("keyup",e,false);this.handleResize();this.update()};THREE.OrthographicTrackballControls.prototype=Object.create(THREE.EventDispatcher.prototype);THREE.OrthographicTrackballControls.prototype.constructor=THREE.OrthographicTrackballControls;
/*! Projector.js from three.js
 * @author mrdoob / http://mrdoob.com/
 * @author supereggbert / http://www.paulbrunt.co.uk/
 * @author julianwa / https://github.com/julianwa
 */
THREE.RenderableObject=function(){this.id=0;this.object=null;this.z=0};THREE.RenderableFace=function(){this.id=0;this.v1=new THREE.RenderableVertex();this.v2=new THREE.RenderableVertex();this.v3=new THREE.RenderableVertex();this.normalModel=new THREE.Vector3();this.vertexNormalsModel=[new THREE.Vector3(),new THREE.Vector3(),new THREE.Vector3()];this.vertexNormalsLength=0;this.color=new THREE.Color();this.material=null;this.uvs=[new THREE.Vector2(),new THREE.Vector2(),new THREE.Vector2()];this.z=0};THREE.RenderableVertex=function(){this.position=new THREE.Vector3();this.positionWorld=new THREE.Vector3();this.positionScreen=new THREE.Vector4();this.visible=true};THREE.RenderableVertex.prototype.copy=function(a){this.positionWorld.copy(a.positionWorld);this.positionScreen.copy(a.positionScreen)};THREE.RenderableLine=function(){this.id=0;this.v1=new THREE.RenderableVertex();this.v2=new THREE.RenderableVertex();this.vertexColors=[new THREE.Color(),new THREE.Color()];this.material=null;this.z=0};THREE.RenderableSprite=function(){this.id=0;this.object=null;this.x=0;this.y=0;this.z=0;this.rotation=0;this.scale=new THREE.Vector2();this.material=null};THREE.Projector=function(){var U,D,N=[],n=0,w,c,f=[],b=0,l,B,G=[],y=0,i,Q,S=[],u=0,z,q,e=[],T=0,J={objects:[],lights:[],elements:[]},M=new THREE.Vector3(),K=new THREE.Vector3(),H=new THREE.Vector3(),L=new THREE.Vector3(),I=new THREE.Vector4(),r=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),V=new THREE.Box3(),P=new Array(3),O=new Array(4),a=new THREE.Matrix4(),g=new THREE.Matrix4(),A,C=new THREE.Matrix4(),o=new THREE.Matrix3(),R=new THREE.Frustum(),t=new THREE.Vector4(),h=new THREE.Vector4();this.projectVector=function(W,X){console.warn("THREE.Projector: .projectVector() is now vector.project().");W.project(X)};this.unprojectVector=function(W,X){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject().");W.unproject(X)};this.pickingRay=function(W,X){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var d=function(){var ai=[];var ae=[];var ad=null;var ag=null;var ac=new THREE.Matrix3();var aa=function(ak){ad=ak;ag=ad.material;ac.getNormalMatrix(ad.matrixWorld);ai.length=0;ae.length=0};var af=function(am){var ak=am.position;var an=am.positionWorld;var al=am.positionScreen;an.copy(ak).applyMatrix4(A);al.copy(an).applyMatrix4(g);var ao=1/al.w;al.x*=ao;al.y*=ao;al.z*=ao;am.visible=al.x>=-1&&al.x<=1&&al.y>=-1&&al.y<=1&&al.z>=-1&&al.z<=1};var X=function(ak,am,al){w=v();w.position.set(ak,am,al);af(w)};var Z=function(ak,am,al){ai.push(ak,am,al)};var Y=function(ak,al){ae.push(ak,al)};var ab=function(am,al,ak){if(am.visible===true||al.visible===true||ak.visible===true){return true}P[0]=am.positionScreen;P[1]=al.positionScreen;P[2]=ak.positionScreen;return r.isIntersectionBox(V.setFromPoints(P))};var ah=function(am,al,ak){return((ak.positionScreen.x-am.positionScreen.x)*(al.positionScreen.y-am.positionScreen.y)-(ak.positionScreen.y-am.positionScreen.y)*(al.positionScreen.x-am.positionScreen.x))<0};var aj=function(al,ak){var an=f[al];var am=f[ak];i=F();i.id=ad.id;i.v1.copy(an);i.v2.copy(am);i.z=(an.positionScreen.z+am.positionScreen.z)/2;i.material=ad.material;J.elements.push(i)};var W=function(au,ar,ap){var av=f[au];var at=f[ar];var aq=f[ap];if(ab(av,at,aq)===false){return}if(ag.side===THREE.DoubleSide||ah(av,at,aq)===true){l=k();l.id=ad.id;l.v1.copy(av);l.v2.copy(at);l.v3.copy(aq);l.z=(av.positionScreen.z+at.positionScreen.z+aq.positionScreen.z)/3;for(var an=0;an<3;an++){var am=arguments[an]*3;var ao=l.vertexNormalsModel[an];ao.set(ai[am],ai[am+1],ai[am+2]);ao.applyMatrix3(ac).normalize();var ak=arguments[an]*2;var al=l.uvs[an];al.set(ae[ak],ae[ak+1])}l.vertexNormalsLength=3;l.material=ad.material;J.elements.push(l)}};return{setObject:aa,projectVertex:af,checkTriangleVisibility:ab,checkBackfaceCulling:ah,pushVertex:X,pushNormal:Z,pushUv:Y,pushLine:aj,pushTriangle:W}};var E=new d();this.projectScene=function(at,ak,av,Z){B=0;Q=0;q=0;J.elements.length=0;if(at.autoUpdate===true){at.updateMatrixWorld()}if(ak.parent===undefined){ak.updateMatrixWorld()}a.copy(ak.matrixWorldInverse.getInverse(ak.matrixWorld));g.multiplyMatrices(ak.projectionMatrix,a);R.setFromMatrix(g);D=0;J.objects.length=0;J.lights.length=0;at.traverseVisible(function(aX){if(aX instanceof THREE.Light){J.lights.push(aX)}else{if(aX instanceof THREE.Mesh||aX instanceof THREE.Line||aX instanceof THREE.Sprite){if(aX.material.visible===false){return}if(aX.frustumCulled===false||R.intersectsObject(aX)===true){U=m();U.id=aX.id;U.object=aX;L.setFromMatrixPosition(aX.matrixWorld);L.applyProjection(g);U.z=L.z;J.objects.push(U)}}}});if(av===true){J.objects.sort(p)}for(var aJ=0,ay=J.objects.length;aJ<ay;aJ++){var aF=J.objects[aJ].object;var ag=aF.geometry;E.setObject(aF);A=aF.matrixWorld;c=0;if(aF instanceof THREE.Mesh){if(ag instanceof THREE.BufferGeometry){var aD=ag.attributes;var ap=ag.offsets;if(aD.position===undefined){continue}var ae=aD.position.array;for(var aP=0,aN=ae.length;aP<aN;aP+=3){E.pushVertex(ae[aP],ae[aP+1],ae[aP+2])}if(aD.normal!==undefined){var an=aD.normal.array;for(var aP=0,aN=an.length;aP<aN;aP+=3){E.pushNormal(an[aP],an[aP+1],an[aP+2])}}if(aD.uv!==undefined){var aC=aD.uv.array;for(var aP=0,aN=aC.length;aP<aN;aP+=2){E.pushUv(aC[aP],aC[aP+1])}}if(aD.index!==undefined){var Y=aD.index.array;if(ap.length>0){for(var aJ=0;aJ<ap.length;aJ++){var aE=ap[aJ];var aw=aE.index;for(var aP=aE.start,aN=aE.start+aE.count;aP<aN;aP+=3){E.pushTriangle(Y[aP]+aw,Y[aP+1]+aw,Y[aP+2]+aw)}}}else{for(var aP=0,aN=Y.length;aP<aN;aP+=3){E.pushTriangle(Y[aP],Y[aP+1],Y[aP+2])}}}else{for(var aP=0,aN=ae.length/3;aP<aN;aP+=3){E.pushTriangle(aP,aP+1,aP+2)}}}else{if(ag instanceof THREE.Geometry){var X=ag.vertices;var af=ag.faces;var aB=ag.faceVertexUvs[0];o.getNormalMatrix(A);var ac=aF.material instanceof THREE.MeshFaceMaterial;var ao=ac===true?aF.material:null;for(var aG=0,ai=X.length;aG<ai;aG++){var am=X[aG];E.pushVertex(am.x,am.y,am.z)}for(var aQ=0,au=af.length;aQ<au;aQ++){var ad=af[aQ];var aO=ac===true?ao.materials[ad.materialIndex]:aF.material;if(aO===undefined){continue}var aj=aO.side;var aW=f[ad.a];var aU=f[ad.b];var aS=f[ad.c];if(aO.morphTargets===true){var ah=ag.morphTargets;var aM=aF.morphTargetInfluences;var aa=aW.position;var aL=aU.position;var ar=aS.position;M.set(0,0,0);K.set(0,0,0);H.set(0,0,0);for(var aI=0,W=ah.length;aI<W;aI++){var az=aM[aI];if(az===0){continue}var aA=ah[aI].vertices;M.x+=(aA[ad.a].x-aa.x)*az;M.y+=(aA[ad.a].y-aa.y)*az;M.z+=(aA[ad.a].z-aa.z)*az;K.x+=(aA[ad.b].x-aL.x)*az;K.y+=(aA[ad.b].y-aL.y)*az;K.z+=(aA[ad.b].z-aL.z)*az;H.x+=(aA[ad.c].x-ar.x)*az;H.y+=(aA[ad.c].y-ar.y)*az;H.z+=(aA[ad.c].z-ar.z)*az}aW.position.add(M);aU.position.add(K);aS.position.add(H);E.projectVertex(aW);E.projectVertex(aU);E.projectVertex(aS)}if(E.checkTriangleVisibility(aW,aU,aS)===false){continue}var aq=E.checkBackfaceCulling(aW,aU,aS);if(aj!==THREE.DoubleSide){if(aj===THREE.FrontSide&&aq===false){continue}if(aj===THREE.BackSide&&aq===true){continue}}l=k();l.id=aF.id;l.v1.copy(aW);l.v2.copy(aU);l.v3.copy(aS);l.normalModel.copy(ad.normal);if(aq===false&&(aj===THREE.BackSide||aj===THREE.DoubleSide)){l.normalModel.negate()}l.normalModel.applyMatrix3(o).normalize();var ab=ad.vertexNormals;for(var aK=0,aT=Math.min(ab.length,3);aK<aT;aK++){var aV=l.vertexNormalsModel[aK];aV.copy(ab[aK]);if(aq===false&&(aj===THREE.BackSide||aj===THREE.DoubleSide)){aV.negate()}aV.applyMatrix3(o).normalize()}l.vertexNormalsLength=ab.length;var al=aB[aQ];if(al!==undefined){for(var aH=0;aH<3;aH++){l.uvs[aH].copy(al[aH])}}l.color=ad.color;l.material=aO;l.z=(aW.positionScreen.z+aU.positionScreen.z+aS.positionScreen.z)/3;J.elements.push(l)}}}}else{if(aF instanceof THREE.Line){if(ag instanceof THREE.BufferGeometry){var aD=ag.attributes;if(aD.position!==undefined){var ae=aD.position.array;for(var aP=0,aN=ae.length;aP<aN;aP+=3){E.pushVertex(ae[aP],ae[aP+1],ae[aP+2])}if(aD.index!==undefined){var Y=aD.index.array;for(var aP=0,aN=Y.length;aP<aN;aP+=2){E.pushLine(Y[aP],Y[aP+1])}}else{var ax=aF.mode===THREE.LinePieces?2:1;for(var aP=0,aN=(ae.length/3)-1;aP<aN;aP+=ax){E.pushLine(aP,aP+1)}}}}else{if(ag instanceof THREE.Geometry){C.multiplyMatrices(g,A);var X=aF.geometry.vertices;if(X.length===0){continue}aW=v();aW.positionScreen.copy(X[0]).applyMatrix4(C);var ax=aF.mode===THREE.LinePieces?2:1;for(var aG=1,ai=X.length;aG<ai;aG++){aW=v();aW.positionScreen.copy(X[aG]).applyMatrix4(C);if((aG+1)%ax>0){continue}aU=f[c-2];t.copy(aW.positionScreen);h.copy(aU.positionScreen);if(x(t,h)===true){t.multiplyScalar(1/t.w);h.multiplyScalar(1/h.w);i=F();i.id=aF.id;i.v1.positionScreen.copy(t);i.v2.positionScreen.copy(h);i.z=Math.max(t.z,h.z);i.material=aF.material;if(aF.material.vertexColors===THREE.VertexColors){i.vertexColors[0].copy(aF.geometry.colors[aG]);i.vertexColors[1].copy(aF.geometry.colors[aG-1])}J.elements.push(i)}}}}}else{if(aF instanceof THREE.Sprite){I.set(A.elements[12],A.elements[13],A.elements[14],1);I.applyMatrix4(g);var aR=1/I.w;I.z*=aR;if(I.z>=-1&&I.z<=1){z=j();z.id=aF.id;z.x=I.x*aR;z.y=I.y*aR;z.z=I.z;z.object=aF;z.rotation=aF.rotation;z.scale.x=aF.scale.x*Math.abs(z.x-(I.x+ak.projectionMatrix.elements[0])/(I.w+ak.projectionMatrix.elements[12]));z.scale.y=aF.scale.y*Math.abs(z.y-(I.y+ak.projectionMatrix.elements[5])/(I.w+ak.projectionMatrix.elements[13]));z.material=aF.material;J.elements.push(z)}}}}}if(Z===true){J.elements.sort(p)}return J};function m(){if(D===n){var W=new THREE.RenderableObject();N.push(W);n++;D++;return W}return N[D++]}function v(){if(c===b){var W=new THREE.RenderableVertex();f.push(W);b++;c++;return W}return f[c++]}function k(){if(B===y){var W=new THREE.RenderableFace();G.push(W);y++;B++;return W}return G[B++]}function F(){if(Q===u){var W=new THREE.RenderableLine();S.push(W);u++;Q++;return W}return S[Q++]}function j(){if(q===T){var W=new THREE.RenderableSprite();e.push(W);T++;q++;return W}return e[q++]}function p(X,W){if(X.z!==W.z){return W.z-X.z}else{if(X.id!==W.id){return X.id-W.id}else{return 0}}}function x(aa,Z){var Y=0,ad=1,ab=aa.z+aa.w,X=Z.z+Z.w,W=-aa.z+aa.w,ac=-Z.z+Z.w;if(ab>=0&&X>=0&&W>=0&&ac>=0){return true}else{if((ab<0&&X<0)||(W<0&&ac<0)){return false}else{if(ab<0){Y=Math.max(Y,ab/(ab-X))}else{if(X<0){ad=Math.min(ad,ab/(ab-X))}}if(W<0){Y=Math.max(Y,W/(W-ac))}else{if(ac<0){ad=Math.min(ad,W/(W-ac))}}if(ad<Y){return false}else{aa.lerp(Z,Y);Z.lerp(aa,1-ad);return true}}}}};
/*! icn3d.js
 * iCn3D has been developed based on iview (http://istar.cse.cuhk.edu.hk/iview/). The following new features has been added so far.
 * 1. Allowed users to pick atoms, both in perspective and orthographics camera. In order to make this work, the methods of rotation, translation and zooming have been dramatically changed.
 * 2. Allowed users to select residues based on structure, chain, sequence, etc. Userscan also defne their own subset and save the selection.
 * 3. Used standard libraries from three.js for rotation, translation, and zooming.
 * 4. Improved the labeling mechanism.
 * 5. The picking allows users to pick atoms, add labels, choose a new rotation center, etc.
 * 6. Added key operations for rotation, translation, and zooming.
 * 7. Enabled to show nucleotides.
 * 8. Make the tubes shiny.
 * 9. Enabled to save the current state and open the state later.
 *
 * iCn3D used the following standard libraries. We can easily adopt the new versions of these libraries.
 * 1. jquery and jquery ui. Jquery ui is used for show the menu at the top.
 * 2. Recent version of Three.js.
 * 3. surface.js from the iview group in Hongkong for displaying molecular surfaces.
 *
 * Files in #4-9 are combined in one file: full_ui_all.min.js.
 *
 * 4. The rotation, translation operation libraries from Three.js: TrackballControls.js and OrthographicTrackballControls.js.
 * 5. Projector.js from Three.js for the picking.
 * 6. Canvas render library: CanvasRenderer.js. This is used when WebGL render is no working in the browser.
 * 7. A library to detect whether WebGL is working in the browser: Detector.js.
 * 8. The 3D drawing library: icn3d.js
 * 9. Advanced UI library for iCn3D: full_ui.js.
 */
if(typeof jQuery==="undefined"){throw new Error("iCn3D requires jQuery")}var iCn3D=function(b){this.REVISION="1";this.id=b;this.container=$("#"+b);this.overdraw=0;this.bHighlight=1;if(Detector.webgl){this.renderer=new THREE.WebGLRenderer({canvas:this.container.get(0),antialias:true,preserveDrawingBuffer:true});this.overdraw=0}else{alert("Currently your web browser has a problem on WebGL, and CanvasRenderer instead of WebGLRenderer is used. If you are using Chrome, open a new tab for the same URL and WebGL may work again.");this.renderer=new THREE.CanvasRenderer({canvas:this.container.get(0)});this.overdraw=0.5;this.bHighlight=2}this.matShader=this.setOutlineColor("yellow");this.fractionOfColor=new THREE.Color(0.1,0.1,0.1);this.WIDTH=this.container.width(),this.HEIGHT=this.container.height();this.setWidthHeight(this.WIDTH,this.HEIGHT);this.axis=false;this.picking=1;this.pickpair=false;this.pickedatomNum=0;this.pickedatom=undefined;this.pickedatom2=undefined;this.bStopRotate=false;this.bCalphaOnly=false;this.bSSOnly=false;this.effects={none:this.renderer};this.maxD=500;this.camera_z=-this.maxD*2;this.commands=[];this.logs=[];this.bRender=true;this.highlightColor=new THREE.Color(16776960);this.sphereGeometry=new THREE.SphereGeometry(1,32,32);this.boxGeometry=new THREE.BoxGeometry(1,1,1);this.cylinderGeometry=new THREE.CylinderGeometry(1,1,1,32,1);this.cylinderGeometryOutline=new THREE.CylinderGeometry(1,1,1,32,1,true);this.sphereRadius=1.5;this.cylinderRadius=0.4;this.linewidth=1;this.curveWidth=3;this.helixSheetWidth=1.3;this.coilWidth=0.3;this.thickness=0.4;this.axisDIV=5;this.strandDIV=6;this.tubeDIV=8;this.LABELSIZE=40;this.nucleicAcidStrandDIV=6;this.nucleicAcidWidth=0.8;this.options={camera:"perspective",background:"black",color:"spectrum",sidechains:"nothing",secondary:"cylinder & plate",surface:"Van der Waals surface",wireframe:"no",opacity:"0.8",ligands:"stick",water:"nothing",ions:"sphere",hbonds:"no",labels:"no",lines:"no",rotationcenter:"molecule center",axis:"no",picking:"no",nucleotides:"nucleotide cartoon",showsurface:"no"};this._zoomFactor=1;this.mouseChange=new THREE.Vector2(0,0);this.quaternion=new THREE.Quaternion(0,0,0,1);var a=this;this.container.bind("contextmenu",function(c){c.preventDefault()});a.typetext=false;$(document).bind("keydown",function(h){if(!a.controls){return}a.bStopRotate=true;$("input, textarea").focus(function(){a.typetext=true});$("input, textarea").blur(function(){a.typetext=false});if(!a.typetext){if(h.keyCode===90){var c={};if(a.camera===a.perspectiveCamera){c._zoomFactor=0.9}else{if(a.camera===a.orthographicCamera){if(a._zoomFactor<0.1){a._zoomFactor=0.1}else{if(a._zoomFactor>1){a._zoomFactor=1}}c._zoomFactor=a._zoomFactor*0.9;if(c._zoomFactor<0.1){c._zoomFactor=0.1}}}c.update=true;a.controls.update(c)}else{if(h.keyCode===88){var c={};if(a.camera===a.perspectiveCamera){c._zoomFactor=1.1}else{if(a.camera===a.orthographicCamera){if(a._zoomFactor>20){a._zoomFactor=20}else{if(a._zoomFactor<1){a._zoomFactor=1}}c._zoomFactor=a._zoomFactor*1.03;if(c._zoomFactor>20){c._zoomFactor=20}}}c.update=true;a.controls.update(c)}else{if(h.keyCode===76){var d=new THREE.Vector3(0,1,0);var i=-5/180*Math.PI;d.applyQuaternion(a.camera.quaternion).normalize();var g=new THREE.Quaternion();g.setFromAxisAngle(d,-i);var c={};c.quaternion=g;c.update=true;a.controls.update(c)}else{if(h.keyCode===74){var d=new THREE.Vector3(0,1,0);var i=5/180*Math.PI;d.applyQuaternion(a.camera.quaternion).normalize();var g=new THREE.Quaternion();g.setFromAxisAngle(d,-i);var c={};c.quaternion=g;c.update=true;a.controls.update(c)}else{if(h.keyCode===73){var d=new THREE.Vector3(1,0,0);var i=-5/180*Math.PI;d.applyQuaternion(a.camera.quaternion).normalize();var g=new THREE.Quaternion();g.setFromAxisAngle(d,-i);var c={};c.quaternion=g;c.update=true;a.controls.update(c)}else{if(h.keyCode===77){var d=new THREE.Vector3(1,0,0);var i=5/180*Math.PI;d.applyQuaternion(a.camera.quaternion).normalize();var g=new THREE.Quaternion();g.setFromAxisAngle(d,-i);var c={};c.quaternion=g;c.update=true;a.controls.update(c)}else{if(h.keyCode===37){h.preventDefault();var f=new THREE.Vector2(0,0);f.x-=0.01;var c={};c.mouseChange=f;c.update=true;a.controls.update(c)}else{if(h.keyCode===39){h.preventDefault();var f=new THREE.Vector2(0,0);f.x+=0.01;var c={};c.mouseChange=f;c.update=true;a.controls.update(c)}else{if(h.keyCode===38){h.preventDefault();var f=new THREE.Vector2(0,0);f.y-=0.01;var c={};c.mouseChange=f;c.update=true;a.controls.update(c)}else{if(h.keyCode===40){h.preventDefault();var f=new THREE.Vector2(0,0);f.y+=0.01;var c={};c.mouseChange=f;c.update=true;a.controls.update(c)}}}}}}}}}}a.render()}});this.container.bind("mouseup touchend",function(c){a.isDragging=false});this.container.bind("mousedown touchstart",function(i){i.preventDefault();if(!a.scene){return}a.bStopRotate=true;var d=i.pageX,j=i.pageY;if(i.originalEvent.targetTouches&&i.originalEvent.targetTouches[0]){d=i.originalEvent.targetTouches[0].pageX;j=i.originalEvent.targetTouches[0].pageY}a.isDragging=true;if(a.picking){a.mouse.x=((d-a.container.offset().left)/a.container.width())*2-1;a.mouse.y=-((j-a.container.offset().top)/a.container.height())*2+1;var h=new THREE.Vector3();h.x=a.mouse.x;h.y=a.mouse.y;if(this.camera_z>0){h.z=-1}else{h.z=1}if(a.camera===a.perspectiveCamera){if(this.camera_z>0){h.z=-1}else{h.z=1}h.unproject(a.camera);a.raycaster.set(a.camera.position,h.sub(a.camera.position).normalize())}else{if(a.camera===a.orthographicCamera){if(this.camera_z>0){h.z=1}else{h.z=-1}h.unproject(a.camera);a.raycaster.set(h,new THREE.Vector3(0,0,-1).transformDirection(a.camera.matrixWorld))}}var g=a.raycaster.intersectObjects(a.objects);if(g.length>0){g[0].point.sub(a.mdl.position);var c=1;var f=a.getAtomsFromPosition(g[0].point,c);while(!f&&c<10){++c;f=a.getAtomsFromPosition(g[0].point,c)}if(f){if(a.pickpair){if(a.pickedatomNum%2===0){a.pickedatom=f}else{a.pickedatom2=f}++a.pickedatomNum}else{a.pickedatom=f}a.showPicking(f)}else{console.log("No atoms were found in 10 andstrom range")}}}a.controls.handleResize();a.controls.update();a.render()});this.container.bind("mousemove touchmove",function(c){c.preventDefault();if(!a.scene){return}if(!a.isDragging){return}a.controls.handleResize();a.controls.update();a.render()});this.container.bind("mousewheel",function(c){c.preventDefault();if(!a.scene){return}a.bStopRotate=true;a.controls.handleResize();a.controls.update();a.render()});this.container.bind("DOMMouseScroll",function(c){c.preventDefault();if(!a.scene){return}a.bStopRotate=true;a.controls.handleResize();a.controls.update();a.render()})};iCn3D.prototype={constructor:iCn3D,setOutlineColor:function(d){var e={outline:{vertex_shader:["uniform float offset;","void main() {","vec4 pos = modelViewMatrix * vec4( position + normal * offset, 1.0 );","gl_Position = projectionMatrix * pos;","}"].join("\n"),fragment_shader:["void main(){","gl_FragColor = vec4( 1.0, 1.0, 0.0, 1.0 );","}"].join("\n")}};if(d==="yellow"){e.outline.fragment_shader=["void main(){","gl_FragColor = vec4( 1.0, 1.0, 0.0, 1.0 );","}"].join("\n")}else{if(d==="green"){e.outline.fragment_shader=["void main(){","gl_FragColor = vec4( 0.0, 1.0, 0.0, 1.0 );","}"].join("\n")}else{if(d==="red"){e.outline.fragment_shader=["void main(){","gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );","}"].join("\n")}}}var a={offset:{type:"f",value:0.5}};var c=e.outline;var b=new THREE.ShaderMaterial({uniforms:a,vertexShader:c.vertex_shader,fragmentShader:c.fragment_shader,depthTest:false,depthWrite:false,needsUpdate:true});return b},setWidthHeight:function(b,a){this.renderer.setSize(b,a);this.container.widthInv=1/b;this.container.heightInv=1/a;this.container.whratio=b/a},nucleotidesArray:["  G","  A","  T","  C","  U"," DG"," DA"," DT"," DC"," DU"],ionsArray:[" NA"," MG"," AL"," CA"," TI"," MN"," FE"," NI"," CU"," ZN"," AG"," BA","  F"," CL"," BR","  I"],vdwRadii:{H:1.08,HE:1.34,LI:1.75,BE:2.05,B:1.47,C:1.49,N:1.41,O:1.4,F:1.39,NE:1.68,NA:1.84,MG:2.05,AL:2.11,SI:2.07,P:1.92,S:1.82,CL:1.83,AR:1.93,K:2.05,CA:2.21,SC:2.16,TI:1.87,V:1.79,CR:1.89,MN:1.97,FE:1.94,CO:1.92,NI:1.84,CU:1.86,ZN:2.1,GA:2.08,GE:2.15,AS:2.06,SE:1.93,BR:1.98,KR:2.12,RB:2.16,SR:2.24,Y:2.19,ZR:1.86,NB:2.07,MO:2.09,TC:2.09,RU:2.07,RH:1.95,PD:2.02,AG:2.03,CD:2.3,IN:2.36,SN:2.33,SB:2.25,TE:2.23,I:2.23,XE:2.21,CS:2.22,BA:2.51,LA:2.4,CE:2.35,PR:2.39,ND:2.29,PM:2.36,SM:2.29,EU:2.33,GD:2.37,TB:2.21,DY:2.29,HO:2.16,ER:2.35,TM:2.27,YB:2.42,LU:2.21,HF:2.12,TA:2.17,W:2.1,RE:2.17,OS:2.16,IR:2.02,PT:2.09,AU:2.17,HG:2.09,TL:2.35,PB:2.32,BI:2.43,PO:2.29,AT:2.36,RN:2.43,FR:2.56,RA:2.43,AC:2.6,TH:2.37,PA:2.43,U:2.4,NP:2.21,PU:2.56,AM:2.56,CM:2.56,BK:2.56,CF:2.56,ES:2.56,FM:2.56,},covalentRadii:{H:0.31,HE:0.28,LI:1.28,BE:0.96,B:0.84,C:0.76,N:0.71,O:0.66,F:0.57,NE:0.58,NA:1.66,MG:1.41,AL:1.21,SI:1.11,P:1.07,S:1.05,CL:1.02,AR:1.06,K:2.03,CA:1.76,SC:1.7,TI:1.6,V:1.53,CR:1.39,MN:1.39,FE:1.32,CO:1.26,NI:1.24,CU:1.32,ZN:1.22,GA:1.22,GE:1.2,AS:1.19,SE:1.2,BR:1.2,KR:1.16,RB:2.2,SR:1.95,Y:1.9,ZR:1.75,NB:1.64,MO:1.54,TC:1.47,RU:1.46,RH:1.42,PD:1.39,AG:1.45,CD:1.44,IN:1.42,SN:1.39,SB:1.39,TE:1.38,I:1.39,XE:1.4,CS:2.44,BA:2.15,LA:2.07,CE:2.04,PR:2.03,ND:2.01,PM:1.99,SM:1.98,EU:1.98,GD:1.96,TB:1.94,DY:1.92,HO:1.92,ER:1.89,TM:1.9,YB:1.87,LU:1.87,HF:1.75,TA:1.7,W:1.62,RE:1.51,OS:1.44,IR:1.41,PT:1.36,AU:1.36,HG:1.32,TL:1.45,PB:1.46,BI:1.48,PO:1.4,AT:1.5,RN:1.5,FR:2.6,RA:2.21,AC:2.15,TH:2.06,PA:2,U:1.96,NP:1.9,PU:1.87,AM:1.8,CM:1.69,},atomColors:{H:new THREE.Color(16777215),He:new THREE.Color(16761035),HE:new THREE.Color(16761035),Li:new THREE.Color(11674146),LI:new THREE.Color(11674146),B:new THREE.Color(65280),C:new THREE.Color(13158600),N:new THREE.Color(9408511),O:new THREE.Color(15728640),F:new THREE.Color(14329120),Na:new THREE.Color(255),NA:new THREE.Color(255),Mg:new THREE.Color(2263842),MG:new THREE.Color(2263842),Al:new THREE.Color(8421520),AL:new THREE.Color(8421520),Si:new THREE.Color(14329120),SI:new THREE.Color(14329120),P:new THREE.Color(16753920),S:new THREE.Color(16762930),Cl:new THREE.Color(65280),CL:new THREE.Color(65280),Ca:new THREE.Color(8421520),CA:new THREE.Color(8421520),Ti:new THREE.Color(8421520),TI:new THREE.Color(8421520),Cr:new THREE.Color(8421520),CR:new THREE.Color(8421520),Mn:new THREE.Color(8421520),MN:new THREE.Color(8421520),Fe:new THREE.Color(16753920),FE:new THREE.Color(16753920),Ni:new THREE.Color(10824234),NI:new THREE.Color(10824234),Cu:new THREE.Color(10824234),CU:new THREE.Color(10824234),Zn:new THREE.Color(10824234),ZN:new THREE.Color(10824234),Br:new THREE.Color(10824234),BR:new THREE.Color(10824234),Ag:new THREE.Color(8421520),AG:new THREE.Color(8421520),I:new THREE.Color(10494192),Ba:new THREE.Color(16753920),BA:new THREE.Color(16753920),Au:new THREE.Color(14329120),AU:new THREE.Color(14329120)},defaultAtomColor:new THREE.Color(13421772),stdChainColors:[new THREE.Color(3329330),new THREE.Color(2003199),new THREE.Color(16416882),new THREE.Color(16753920),new THREE.Color(52945),new THREE.Color(16738740),new THREE.Color(65280),new THREE.Color(255),new THREE.Color(16711680),new THREE.Color(16776960),new THREE.Color(65535),new THREE.Color(16711935),new THREE.Color(3978097),new THREE.Color(4620980),new THREE.Color(13458524),new THREE.Color(16770229),new THREE.Color(11529966),new THREE.Color(15631086),new THREE.Color(25600),new THREE.Color(139),new THREE.Color(9109504),new THREE.Color(13468991),new THREE.Color(35723),new THREE.Color(9699539)],backgroundColors:{black:new THREE.Color(0),grey:new THREE.Color(13421772),white:new THREE.Color(16777215),},residueColors:{ALA:new THREE.Color(13158600),ARG:new THREE.Color(1334015),ASN:new THREE.Color(56540),ASP:new THREE.Color(15075850),CYS:new THREE.Color(15132160),GLN:new THREE.Color(56540),GLU:new THREE.Color(15075850),GLY:new THREE.Color(15461355),HIS:new THREE.Color(8553170),ILE:new THREE.Color(1016335),LEU:new THREE.Color(1016335),LYS:new THREE.Color(1334015),MET:new THREE.Color(15132160),PHE:new THREE.Color(3289770),PRO:new THREE.Color(14456450),SER:new THREE.Color(16422400),THR:new THREE.Color(16422400),TRP:new THREE.Color(11819700),TYR:new THREE.Color(3289770),VAL:new THREE.Color(1016335),ASX:new THREE.Color(16738740),GLX:new THREE.Color(16738740),},defaultResidueColor:new THREE.Color(12492910),polarityColors:{ARG:new THREE.Color(13369344),HIS:new THREE.Color(13369344),LYS:new THREE.Color(13369344),ASP:new THREE.Color(13369344),GLU:new THREE.Color(13369344),SER:new THREE.Color(13369344),THR:new THREE.Color(13369344),ASN:new THREE.Color(13369344),GLN:new THREE.Color(13369344),TYR:new THREE.Color(13369344),GLY:new THREE.Color(52428),PRO:new THREE.Color(52428),ALA:new THREE.Color(52428),VAL:new THREE.Color(52428),LEU:new THREE.Color(52428),ILE:new THREE.Color(52428),MET:new THREE.Color(52428),PHE:new THREE.Color(52428),CYS:new THREE.Color(52428),TRP:new THREE.Color(52428),},ssColors:{helix:new THREE.Color(16711808),sheet:new THREE.Color(16762880),coil:new THREE.Color(6324479),},defaultBondColor:new THREE.Color(2200790),surfaces:{1:undefined,2:undefined,3:undefined,4:undefined},hasCovalentBond:function(b,a){var c=this.covalentRadii[b.elem]+this.covalentRadii[a.elem];return b.coord.distanceToSquared(a.coord)<1.3*c*c},init:function(){this.structures={};this.chains={};this.residues={};this.secondarys={};this.alignChains={};this.chainsSeq={};this.chainsColor={};this.chainsAnno={};this.chainsAnnoTitle={};this.alignChainsSeq={};this.alignChainsAnno={};this.alignChainsAnnoTitle={};this.displayAtoms={};this.highlightAtoms={};this.prevHighlightObjects=[];this.definedNames2Residues={};this.definedNames2Atoms={};this.definedNames2Descr={};this.definedNames2Command={};this.residueId2Name={};this.moleculeTitle="";this.atoms={};this.displayAtoms={};this.highlightAtoms={};this.peptides={};this.nucleotides={};this.nucleotidesP={};this.ligands={};this.ions={};this.water={};this.calphas={};this.hbondpoints=[];this.atomPrevColors={};this.style2atoms={};this.labels=[];this.lines=[];this.inputid={idtype:undefined,id:undefined};this.biomtMatrices=[];this.bAssembly=false},loadPDB:function(F){var V=[],J=[];var aB=F.split("\n");var I={};var ap={};this.init();var Y=[],aE=[],B=[],U=[],az=[],l=[];var u=0;var w=1;var ax,am;var P="",aC="";var ah="";var D={};for(var T in aB){var h=aB[T];var at=h.substr(0,6);if(at==="HEADER"){var ai=h.substr(10,40);var Q=h.substr(62,4);this.moleculeTitle=ai.trim()+" ("+Q+")"}else{if(at==="HELIX "){var ag=h.substr(19,1);var A=parseInt(h.substr(21,4));var a=parseInt(h.substr(33,4));var N;for(var S=A;S<=a;++S){N=ag+"_"+S;U.push(N);if(S===A){az.push(N)}if(S===a){l.push(N)}}V.push({chain:ag,initialResidue:A,initialInscode:h.substr(25,1),terminalResidue:a,terminalInscode:h.substr(37,1),})}else{if(at==="SHEET "){var ag=h.substr(21,1);var A=parseInt(h.substr(22,4));var a=parseInt(h.substr(33,4));for(var S=A;S<=a;++S){var N=ag+"_"+S;Y.push(N);if(S===A){aE.push(N)}if(S===a){B.push(N)}}J.push({chain:ag,initialResidue:A,initialInscode:h.substr(26,1),terminalResidue:a,terminalInscode:h.substr(37,1),})}else{if(at==="HBOND "){bCalculateHbond=false;var k=h.substr(6,1);var q=h.substr(8,4).replace(/ /g,"");var aA=h.substr(14,4).replace(/ /g,"");var au=h.substr(18,1);var c=h.substr(20,4).replace(/ /g,"");var ao=h.substr(25,4).replace(/ /g,"");var g=parseFloat(h.substr(30,8));var f=parseFloat(h.substr(38,8));var d=parseFloat(h.substr(46,8));var r=parseFloat(h.substr(54,8));var p=parseFloat(h.substr(62,8));var o=parseFloat(h.substr(70,8));var b=h.substr(78,8).replace(/ /g,"");this.hbondpoints.push(new THREE.Vector3(g,f,d));this.hbondpoints.push(new THREE.Vector3(r,p,o))}else{if(at==="REMARK"){var Z=parseInt(h.substr(7,3));if(Z==350&&h.substr(13,5)=="BIOMT"){var L=parseInt(h[18])-1;var O=parseInt(h.substr(21,2));if(this.biomtMatrices[O]==undefined){this.biomtMatrices[O]=new THREE.Matrix4().identity()}this.biomtMatrices[O].elements[L]=parseFloat(h.substr(24,9));this.biomtMatrices[O].elements[L+4]=parseFloat(h.substr(34,9));this.biomtMatrices[O].elements[L+8]=parseFloat(h.substr(44,9));this.biomtMatrices[O].elements[L+12]=parseFloat(h.substr(54,10))}}else{if(at==="ENDMDL"){++w}else{if(at==="JRNL  "){if(h.substr(12,4)==="PMID"){this.pmid=h.substr(19).trim()}}else{if(at==="ATOM  "||at==="HETATM"){var aq=h.substr(16,1);++u;var aj=parseInt(h.substr(6,5));D[aj]=u;var t=h.substr(76,2).replace(/ /g,"");if(t===""){t=h.substr(12,2).replace(/ /g,"")}var K=h.substr(21,1);if(K===""){K=1}var af=parseInt(h.substr(22,4));var v=h.substr(12,4).replace(/ /g,"");var N=K+"_"+af;var H=parseFloat(h.substr(30,8));var E=parseFloat(h.substr(38,8));var C=parseFloat(h.substr(46,8));var ac=h.substr(17,3);var ak=new THREE.Vector3(H,E,C);var R={het:at[0]==="H",serial:u,name:v,alt:aq,resn:ac,structure:w,chain:K,resi:af,coord:ak,b:parseFloat(h.substr(60,8)),elem:t,bonds:[],ss:"coil",ssbegin:false,ssend:false};this.atoms[u]=R;this.displayAtoms[u]=1;this.highlightAtoms[u]=1;if($.inArray(N,U)!==-1){this.atoms[u].ss="helix";if($.inArray(N,az)!==-1){this.atoms[u].ssbegin=true}if($.inArray(N,l)!==-1){this.atoms[u].ssend=true}}else{if($.inArray(N,Y)!==-1){this.atoms[u].ss="sheet";if($.inArray(N,aE)!==-1){this.atoms[u].ssbegin=true}if($.inArray(N,B)!==-1){this.atoms[u].ssend=true}}}ax=w+"_"+K;am=ax+"_"+af;var aa="-";if(this.atoms[u].ss==="helix"){aa="H"}else{if(this.atoms[u].ss==="sheet"){aa="E"}else{if(!this.atoms[u].het){aa="C"}}}this.secondarys[am]=aa;if(am!==aC){var ar=this.residueName2Abbr(ac);this.residueId2Name[am]=ar;if(u!==1){this.residues[aC]=ap}ap={};if(ax!==P){if(u!==1){this.chains[P]=this.unionHash2Atoms(this.chains[P],I)}I={};if(this.structures[w.toString()]===undefined){this.structures[w.toString()]=[]}this.structures[w.toString()].push(ax);if(this.chainsSeq[ax]===undefined){this.chainsSeq[ax]=[]}if(this.chainsAnno[ax]===undefined){this.chainsAnno[ax]=[]}if(this.chainsAnno[ax][0]===undefined){this.chainsAnno[ax][0]=[]}if(this.chainsAnno[ax][1]===undefined){this.chainsAnno[ax][1]=[]}if(this.chainsAnnoTitle[ax]===undefined){this.chainsAnnoTitle[ax]=[]}if(this.chainsAnnoTitle[ax][0]===undefined){this.chainsAnnoTitle[ax][0]=[]}if(this.chainsAnnoTitle[ax][1]===undefined){this.chainsAnnoTitle[ax][1]=[]}var av={};av.resi=af;av.name=ar;this.chainsSeq[ax].push(av);var aD="";if(af%10===0){aD=af.toString()}this.chainsAnno[ax][0].push(aD);this.chainsAnno[ax][1].push(aa);this.chainsAnnoTitle[ax][0].push("");this.chainsAnnoTitle[ax][1].push("SS")}else{var av={};av.resi=af;av.name=ar;this.chainsSeq[ax].push(av);var aD="";if(af%10===0){aD=af.toString()}this.chainsAnno[ax][0].push(aD);this.chainsAnno[ax][1].push(aa)}}I[u]=1;ap[u]=1;ah=at;P=ax;aC=am}else{if(at==="CONECT"){var W=parseInt(h.substr(6,5));for(var S=0;S<4;++S){var ae=parseInt(h.substr([11,16,21,26][S],5));if(isNaN(ae)){continue}if(this.atoms[D[W]]!==undefined){this.atoms[D[W]].bonds.push(D[ae])}}}else{if(at==="TER   "){++u}}}}}}}}}}}aB=null;var ar=this.residueName2Abbr(ac);this.chains[ax]=I;this.residues[am]=ap;var X,aw,G,ab=[],an=this;var ad=function(z){var aF=ab.length;for(var y=0;y<aF;++y){var x=ab[y];for(var m=y+1;m<aF;++m){var i=ab[m];if(x.alt===i.alt&&an.hasCovalentBond(x,i)){x.bonds.push(i.serial);i.bonds.push(x.serial)}}z&&z(x)}};var ay=new THREE.Vector3(9999,9999,9999);var e=new THREE.Vector3(-9999,-9999,-9999);var al=new THREE.Vector3();var M=0;for(var T in this.atoms){var v=this.atoms[T];var ak=v.coord;al.add(ak);ay.min(ak);e.max(ak);++M;if(!v.het){if($.inArray(v.resn,this.nucleotidesArray)!==-1){this.nucleotides[v.serial]=1;if(v.name==="P"){this.nucleotidesP[v.serial]=1}}else{this.peptides[v.serial]=1;if(v.name==="CA"){this.calphas[v.serial]=1}}}else{if(v.het){if(v.resn==="HOH"||v.resn==="WAT"){this.water[v.serial]=1}else{if($.inArray(v.resn,this.ionsArray)!==-1){this.ions[v.serial]=1}else{this.ligands[v.serial]=1}}}}if(!(X===v.chain&&aw===v.resi)){ad(function(i){if(((i.name==="C"&&v.name==="N")||(i.name==="O3'"&&v.name==="P"))&&an.hasCovalentBond(i,v)){i.bonds.push(v.serial);v.bonds.push(i.serial)}});X=v.chain;aw=v.resi;ab.length=0}ab.push(v)}ad();this.pmin=ay;this.pmax=e;this.cnt=M;this.maxD=this.pmax.distanceTo(this.pmin);this.center=al.multiplyScalar(1/this.cnt);if(this.maxD<25){this.maxD=25}},cloneHash:function(c,b){for(var a in c){b[a]=c[a]}},residueName2Abbr:function(a){if(a!==undefined&&a.charAt(0)!==" "&&a.charAt(1)===" "){a=a.charAt(0)}switch(a){case"  A":return"A";break;case"  C":return"C";break;case"  G":return"G";break;case"  T":return"T";break;case"  U":return"U";break;case"  I":return"I";break;case"ALA":return"A";break;case"ARG":return"R";break;case"ASN":return"N";break;case"ASP":return"D";break;case"CYS":return"C";break;case"GLU":return"E";break;case"GLN":return"Q";break;case"GLY":return"G";break;case"HIS":return"H";break;case"ILE":return"I";break;case"LEU":return"L";break;case"LYS":return"K";break;case"MET":return"M";break;case"PHE":return"F";break;case"PRO":return"P";break;case"SER":return"S";break;case"THR":return"T";break;case"TRP":return"W";break;case"TYR":return"Y";break;case"VAL":return"V";break;case"SEC":return"U";break;case"PYL":return"O";break;default:return a}},calculateLigandHbonds:function(n,q,l){if(Object.keys(n).length===0||Object.keys(q).length===0){return}var g={};var o;var r=l*l;for(var h in n){var m=n[h];if(m.elem==="N"||m.elem==="O"||m.elem==="F"){o=m.structure+"_"+m.chain+"_"+m.resi+"_"+m.name;g[o]=m}}this.highlightAtoms={};for(var h in q){var m=q[h];if(m.elem==="N"||m.elem==="O"||m.elem==="F"){o=m.structure+"_"+m.chain+"_"+m.resi+"_"+m.name;for(var f in g){var e=Math.abs(m.coord.x-g[f].coord.x);if(e>l){continue}var c=Math.abs(m.coord.y-g[f].coord.y);if(c>l){continue}var a=Math.abs(m.coord.z-g[f].coord.z);if(a>l){continue}var p=e*e+c*c+a*a;if(p>r){continue}var b=f.split("_");this.hbondpoints.push(m.coord);this.hbondpoints.push(g[f].coord);for(var d in this.residues[b[0]+"_"+b[1]+"_"+b[2]]){this.highlightAtoms[d]=1}}}}},createSphere:function(c,e,d,f,b){var g;if(e===undefined){e=0.8}if(d===undefined){d=false}if(f===undefined){f=1}if(b===2){if(f>0.9){f=1.5}else{if(f<0.5){f=1}}var a=this.highlightColor;g=new THREE.Mesh(this.sphereGeometry,new THREE.MeshPhongMaterial({transparent:true,opacity:0.5,metal:false,overdraw:this.overdraw,specular:this.fractionOfColor,shininess:30,emissive:0,color:a}))}else{if(b===1){g=new THREE.Mesh(this.sphereGeometry,this.matShader)}else{var a=c.color;g=new THREE.Mesh(this.sphereGeometry,new THREE.MeshPhongMaterial({metal:false,overdraw:this.overdraw,specular:this.fractionOfColor,shininess:30,emissive:0,color:a}))}}g.scale.x=g.scale.y=g.scale.z=d?e:(this.vdwRadii[c.elem]||e)*(f?f:1);g.position.copy(c.coord);this.mdl.add(g);if(b===1||b===2){this.prevHighlightObjects.push(g)}else{this.objects.push(g)}},createBox:function(c,e,d,f,a,b){var g;if(e===undefined){e=0.8}if(d===undefined){d=false}if(f===undefined){f=0.8}if(b){if(a===undefined){a=this.highlightColor}g=new THREE.Mesh(this.boxGeometry,new THREE.MeshPhongMaterial({transparent:true,opacity:0.5,metal:false,overdraw:this.overdraw,specular:this.fractionOfColor,shininess:30,emissive:0,color:a}))}else{if(a===undefined){a=c.color}g=new THREE.Mesh(this.boxGeometry,new THREE.MeshPhongMaterial({metal:false,overdraw:this.overdraw,specular:this.fractionOfColor,shininess:30,emissive:0,color:a}))}g.scale.x=g.scale.y=g.scale.z=d?e:(this.vdwRadii[c.elem]||e)*(f?f:1);g.position.copy(c.coord);this.mdl.add(g);if(b){this.prevHighlightObjects.push(g)}else{this.objects.push(g)}},createCylinder:function(f,d,a,b,c){var e;if(c===2){e=new THREE.Mesh(this.cylinderGeometry,new THREE.MeshPhongMaterial({transparent:true,opacity:0.5,metal:false,overdraw:this.overdraw,specular:this.fractionOfColor,shininess:30,emissive:0,color:b}));a*=1.5}else{if(c===1){e=new THREE.Mesh(this.cylinderGeometryOutline,this.matShader)}else{e=new THREE.Mesh(this.cylinderGeometry,new THREE.MeshPhongMaterial({metal:false,overdraw:this.overdraw,specular:this.fractionOfColor,shininess:30,emissive:0,color:b}))}}e.position.copy(f).add(d).multiplyScalar(0.5);e.matrixAutoUpdate=false;e.lookAt(f);e.updateMatrix();e.matrix.multiply(new THREE.Matrix4().makeScale(a,a,f.distanceTo(d))).multiply(new THREE.Matrix4().makeRotationX(Math.PI*0.5));this.mdl.add(e);if(c===1||c===2){this.prevHighlightObjects.push(e)}else{this.objects.push(e)}},createRepresentationSub:function(d,b,a){var h=new THREE.Geometry();for(var g in d){var f=d[g];b&&b(f);for(var e in f.bonds){var c=this.atoms[f.bonds[e]];if(c===undefined||c.serial<f.serial){continue}a&&a(f,c)}}},createSphereRepresentation:function(a,e,d,f,b){var c=this;this.createRepresentationSub(a,function(g){c.createSphere(g,e,d,f,b)})},createBoxRepresentation_P_CA:function(a,d,b){var c=this;this.createRepresentationSub(a,function(e){if(e.name==="CA"||e.name==="P"){c.createBox(e,undefined,undefined,d,undefined,b)}})},createStickRepresentation:function(b,a,f,e,c){var d=this;if(c!==2){this.createRepresentationSub(b,function(g){d.createSphere(g,a,!e,e,c)},function(h,g){if(h.color===g.color){d.createCylinder(h.coord,g.coord,f,h.color,c)}else{var i=h.coord.clone().add(g.coord).multiplyScalar(0.5);d.createCylinder(h.coord,i,f,h.color,c);d.createCylinder(g.coord,i,f,g.color,c)}})}else{if(c===2){this.createBoxRepresentation_P_CA(b,1.2,c)}}},createLineRepresentation:function(b,c){var d=this;var e=new THREE.Geometry();this.createRepresentationSub(b,undefined,function(g,f){if(g.color===f.color){e.vertices.push(g.coord);e.vertices.push(f.coord);e.colors.push(g.color);e.colors.push(f.color)}else{var h=g.coord.clone().add(f.coord).multiplyScalar(0.5);e.vertices.push(g.coord);e.vertices.push(h);e.vertices.push(f.coord);e.vertices.push(h);e.colors.push(g.color);e.colors.push(g.color);e.colors.push(f.color);e.colors.push(f.color)}});if(c!==2){var a;if(c===1){}else{a=new THREE.Line(e,new THREE.LineBasicMaterial({linewidth:this.linewidth,vertexColors:true}),THREE.LinePieces)}this.mdl.add(a);if(c===1){this.prevHighlightObjects.push(a)}else{this.objects.push(a)}}else{if(c===2){this.createBoxRepresentation_P_CA(b,0.8,c)}}},subdivide:function(g,u,o,B){var C=[];var w=new Array();w.push(g[0]);for(var A=1,k=g.length-1;A<k;++A){var d=g[A],c=g[A+1];w.push(d.smoothen?d.clone().add(c).multiplyScalar(0.5):d)}w.push(g[g.length-1]);var h=[];for(var A=-1,q=w.length,r=1/u;A<=q-3;++A){var d=w[A===-1?0:A];var c=w[A+1],b=w[A+2];var a=w[A===q-3?q-1:A+3];var f=b.clone().sub(d).multiplyScalar(0.5);var e=a.clone().sub(c).multiplyScalar(0.5);if(A>-1&&B&&o!==undefined&&o[A+1]){C=C.concat(h)}h=[];for(var v=0;v<u;++v){var p=r*v;var n=c.x+p*f.x+p*p*(-3*c.x+3*b.x-2*f.x-e.x)+p*p*p*(2*c.x-2*b.x+f.x+e.x);var m=c.y+p*f.y+p*p*(-3*c.y+3*b.y-2*f.y-e.y)+p*p*p*(2*c.y-2*b.y+f.y+e.y);var l=c.z+p*f.z+p*p*(-3*c.z+3*b.z-2*f.z-e.z)+p*p*p*(2*c.z-2*b.z+f.z+e.z);if(!o){C.push(new THREE.Vector3(n,m,l))}else{if(o[A+1]){if(v<=parseInt((u+1)/2)){C.push(new THREE.Vector3(n,m,l))}}else{if(o[A+2]){if(v>=parseInt((u+1)/2)){h.push(new THREE.Vector3(n,m,l))}}}}}}if(!o||o[A+1]){if(B){C=C.concat(h)}C.push(w[w.length-1])}return C},createCurveSubArrow:function(c,d,a,b,k,h,i,j,g,m,l){var e=[],f=[];e.push(c);f.push(j);this.prepareStrand(e,f,d,a,b,undefined,k,h,i,g,m,false,l)},createCurveSub:function(f,c,a,b,o,j,k,p){if(f.length===0){return}b=b||5;var q;if(!k){q=this.subdivide(f,b,p,o)}else{q=f}if(q.length===0){return}var h=new THREE.Geometry();if(o===2&&j){for(var g=0,d=1/b;g<q.length;++g){q[g].addScalar(0.6);h.vertices.push(q[g]);h.colors.push(new THREE.Color(a[g===0?0:Math.round((g-1)*d)]))}}else{if(o===1){var m=this.coilWidth/2;var e=32;var l=false;if(q.length>1){var n=new THREE.TubeGeometry(new THREE.SplineCurve3(q),q.length,m,e,l);mesh=new THREE.Mesh(n,this.matShader);this.mdl.add(mesh);this.prevHighlightObjects.push(mesh)}}else{for(var g=0,d=1/b;g<q.length;++g){h.vertices.push(q[g]);h.colors.push(new THREE.Color(a[g===0?0:Math.round((g-1)*d)]))}}}var r=new THREE.Line(h,new THREE.LineBasicMaterial({linewidth:c,vertexColors:true}),THREE.LineStrip);this.mdl.add(r);if(o===2){this.prevHighlightObjects.push(r)}else{this.objects.push(r)}},createLines:function(h){if(h!==undefined){for(var d in h){var j=h[d];var g=j.position1;var f=j.position2;var e;if(j.color){var b=/^\#([0-9a-f]{6})$/i.exec(j.color);e=parseInt(b[1],16)}else{e=16776960}var c=(j.dashed)?j.dashed:false;var a=0.3;this.mdl.add(this.createSingleLine(g,f,e,c,a))}}},createCylinderCurve:function(g,k,j,n,l){var c=null;var b,f;var e;var m=[],a=[],d=[];for(e in g){var h=g[e];if(h.het){continue}if(h.name!==k){continue}if(c!==null&&b===h.chain&&f+1===h.resi){if(!l){if(n){var o=this.createSingleLine(c.coord,h.coord,h.color,false);this.mdl.add(o);this.objects.push(o)}else{this.createCylinder(c.coord,h.coord,j,h.color);this.createSphere(h,j,true,1)}}else{if(l===1){this.createCylinder(c.coord,h.coord,j,h.color,l);this.createSphere(h,j,true,1,l)}}}c=h;b=h.chain;f=h.resi;if(l===2){this.createBox(h,undefined,undefined,undefined,undefined,l)}}if(c!==null&&b===h.chain&&f+1===h.resi){if(!l){if(n){var o=this.createSingleLine(c.coord,h.coord,h.color,false);this.mdl.add(o);this.objects.push(o)}else{this.createCylinder(c.coord,h.coord,j,h.color)}}else{if(l===1){this.createCylinder(c.coord,h.coord,j,h.color,l);this.createSphere(h,j,true,1,l)}}}},prepareStrand:function(q,h,u,k,p,a,E,t,g,d,D,B,n){if(d.length===1){return}p=p||this.axisDIV;var r=2/(g-1);var C,w,f,m;var z={},A=[];for(var y=0,l=h.length;y<l;++y){z[y]=[]}var c=this.subdivide(d,p);if(c.length===1){return}for(var y=0,l=d.length-2;y<l;++y){for(var e=0,b=h.length;e<b;++e){z[e].push(q[e][y])}A.push(k[y])}A.push(k[y]);for(var y=0,l=h.length;y<l;++y){C=-1+r*h[y];w=c.length-1-p;f=d.length-2;m=new THREE.Vector3(c[w].x+D[f].x*C,c[w].y+D[f].y*C,c[w].z+D[f].z*C);z[y].push(m)}for(var y=0,l=h.length;y<l;++y){z[y]=this.subdivide(z[y],p,n,E)}if(B){this.createStrip(z[0],z[1],A,p,a,E,true)}else{this.createCurveSub(z[0],u,A,p,E,t,true)}for(var y=0,l=h.length;y<l;++y){z[y]=[]}A=[];for(var e=0,b=h.length;e<b;++e){for(var y=p*(d.length-2),l=p*(d.length-1);n[parseInt(y/p)]&&y<l;y=y+p){for(var x=0;x<p;++x){var C=-1+r*h[e];var F=1.8;C=C*F*(p-x)/p;var o=parseInt(y/p);var m=new THREE.Vector3(c[y+x].x+D[o].x*C,c[y+x].y+D[o].y*C,c[y+x].z+D[o].z*C);m.smoothen=true;z[e].push(m)}}var C=0;var w=c.length-1;var f=d.length-1;var m=new THREE.Vector3(c[w].x+D[f].x*C,c[w].y+D[f].y*C,c[w].z+D[f].z*C);m.smoothen=true;z[e].push(m)}A.push(k[k.length-2]);A.push(k[k.length-1]);if(B){this.createStrip(z[0],z[1],A,p,a,E,true)}else{this.createCurveSub(z[0],u,A,p,E,t,true)}},createStripArrow:function(m,l,a,b,k,i,h,c,e,g,n,j){var d=[],f=[];d.push(m);d.push(l);f.push(c);f.push(e);this.prepareStrand(d,f,undefined,a,b,k,i,undefined,h,g,n,true,j)},createStrip:function(e,d,p,v,a,F,w,r){if(e.length<2){return}v=v||this.axisDIV;if(!w){e=this.subdivide(e,v,r,F);d=this.subdivide(d,v,r,F)}if(e.length<2){return}var G=new THREE.Geometry();var z=G.vertices,n=G.faces;var g,C,h,t,D;for(var B=0,k=e.length;B<k;++B){z.push(C=e[B]);z.push(C);z.push(h=d[B]);z.push(h);if(B<k-1){g=d[B].clone().sub(e[B]).cross(e[B+1].clone().sub(e[B])).normalize().multiplyScalar(a)}z.push(t=e[B].clone().add(g));z.push(t);z.push(D=d[B].clone().add(g));z.push(D)}var c=[[0,2,-6,-8],[-4,-2,6,4],[7,3,-5,-1],[-3,-7,1,5]];for(var B=1,k=e.length,E=1/v;B<k;++B){var m=8*B,y=new THREE.Color(p[Math.round((B-1)*E)]);for(var A=0;A<4;++A){n.push(new THREE.Face3(m+c[A][0],m+c[A][1],m+c[A][2],undefined,y));n.push(new THREE.Face3(m+c[A][3],m+c[A][0],m+c[A][2],undefined,y))}}var o=z.length-8;for(var B=0;B<4;++B){z.push(z[B*2]);z.push(z[o+B*2])}o+=8;n.push(new THREE.Face3(o,o+2,o+6,undefined,n[0].color));n.push(new THREE.Face3(o+4,o,o+6,undefined,n[0].color));n.push(new THREE.Face3(o+1,o+5,o+7,undefined,n[n.length-3].color));n.push(new THREE.Face3(o+3,o+1,o+7,undefined,n[n.length-3].color));G.computeFaceNormals();G.computeVertexNormals(false);var b;if(F===2){b=new THREE.Mesh(G,new THREE.MeshPhongMaterial({transparent:true,opacity:0.5,metal:false,overdraw:this.overdraw,specular:this.fractionOfColor,shininess:30,emissive:0,vertexColors:THREE.FaceColors,side:THREE.DoubleSide}));this.mdl.add(b);this.prevHighlightObjects.push(b)}else{if(F===1){var l=this.coilWidth/2;var x=32;var f=false;var u=new THREE.TubeGeometry(new THREE.SplineCurve3(e),e.length,l,x,f);b=new THREE.Mesh(u,this.matShader);this.mdl.add(b);this.prevHighlightObjects.push(b);var q=new THREE.TubeGeometry(new THREE.SplineCurve3(d),d.length,l,x,f);b=new THREE.Mesh(q,this.matShader);this.mdl.add(b);this.prevHighlightObjects.push(b)}else{b=new THREE.Mesh(G,new THREE.MeshPhongMaterial({metal:false,overdraw:this.overdraw,specular:this.fractionOfColor,shininess:30,emissive:0,vertexColors:THREE.FaceColors,side:THREE.DoubleSide}));this.mdl.add(b);this.objects.push(b)}}},createBrick:function(f,a){var c=new THREE.Geometry();for(var b=0,d=f.length;b<d;++b){c.vertices.push(new THREE.Vector3(f[b][0],f[b][1],f[b][2]))}c.faces=[new THREE.Face3(1,5,7,undefined,a),new THREE.Face3(1,7,3,undefined,a),new THREE.Face3(0,2,6,undefined,a),new THREE.Face3(0,6,4,undefined,a),new THREE.Face3(2,3,7,undefined,a),new THREE.Face3(2,7,6,undefined,a),new THREE.Face3(0,4,5,undefined,a),new THREE.Face3(0,5,1,undefined,a),new THREE.Face3(4,6,7,undefined,a),new THREE.Face3(4,7,5,undefined,a),new THREE.Face3(0,1,3,undefined,a),new THREE.Face3(0,3,2,undefined,a)];c.computeFaceNormals();c.computeVertexNormals(false);var e;e=new THREE.Mesh(c,new THREE.MeshPhongMaterial({metal:false,overdraw:this.overdraw,specular:this.fractionOfColor,shininess:30,emissive:0,vertexColors:THREE.FaceColors,side:THREE.DoubleSide}));this.mdl.add(e);this.objects.push(e)},getFirstAtomObj:function(c){var b=Object.keys(c);var a=b[0];return this.atoms[a]},getLastAtomObj:function(c){var a=Object.keys(c);var b=a[a.length-1];return this.atoms[b]},createStrand:function(G,ag,af,z,Q,u,K,C,P){var y=z?true:false;var ai={};if(P===1||P===2){var I=this.getFirstAtomObj(G);var o=this.getLastAtomObj(G);var A=I.resi;if(I.ss!=="coil"&&!(I.ssbegin)){for(var ad=I.resi-1;ad>0;--ad){var M=I.structure+"_"+I.chain+"_"+ad;var b=this.getFirstAtomObj(this.residues[M]);if(b.ss===I.ss&&b.ssbegin){A=b.resi;break}}for(var ad=A;ad<I.resi;++ad){var M=I.structure+"_"+I.chain+"_"+ad;ai=this.unionHash(ai,this.hash2Atoms(this.residues[M]))}}ai=this.unionHash(ai,G);var al=o.resi;if(o.ss!=="coil"&&!(o.ssend)&&!(o.notshow)){var L=this.getLastAtomObj(this.chains[o.structure+"_"+o.chain]).resi;for(var ad=o.resi+1;ad<=L;++ad){var M=o.structure+"_"+o.chain+"_"+ad;var b=this.getFirstAtomObj(this.residues[M]);if(b.ss===o.ss&&b.ssend){al=b.resi;break}}for(var ad=o.resi+1;ad<=al;++ad){var M=o.structure+"_"+o.chain+"_"+ad;ai=this.unionHash(ai,this.hash2Atoms(this.residues[M]))}}if(o.notshow){o.notshow=undefined}}else{ai=G}if(P===2){if(z){z=false;ag=null;af=null;Q=null;u=null;C=undefined}else{z=true;ag=2;af=undefined;Q=undefined;u=undefined;C=this.thickness}}ag=ag||this.strandDIV;af=af||this.axisDIV;Q=Q||this.coilWidth;K=K||false;u=u||this.helixSheetWidth;var X={};for(var ab=0;ab<ag;++ab){X[ab]=[]}var ae=[];var T=[];var F=[];var Z=[],aj=[];var E,R,am=null,W=null,a=null,d=null,l=null,g=null;var U=null,t=null,f=false,ah=null,H=null;var h,ak=false,q=false;var b,m={};this.bCalphaOnly=false;var N=0,r=30;var c=false;for(var ad in G){if(N<r){if(G[ad].name!=="CA"){c=true;break}}else{break}++N}if(!c){this.bCalphaOnly=true}var w=this.hash2Atoms(ai);var S={};for(var ad in w){var b=w[ad];M=b.structure+"_"+b.chain+"_"+b.resi;S[M]=1}var p=Object.keys(S).length;var x=0;for(var ad in ai){b=ai[ad];var e=undefined;if((b.name==="O"||b.name==="CA")&&!b.het){if(b.name==="CA"){if(G.hasOwnProperty(ad)&&(b.ss==="coil"||b.ssend||b.ssbegin)){m[ad]=b}am=b.coord.clone();a=b.color}if(b.name==="O"||(this.bCalphaOnly&&b.name==="CA")){if(b.name==="O"){W=b.coord.clone()}var D=true;if(E!==b.chain||R+1!==b.resi){D=false}if(b.ssend&&b.ss==="sheet"){ak=true}else{if(b.ssend&&b.ss==="helix"){q=true}}if(l){if(P===1||P===2){Z.push(this.highlightColor)}else{Z.push(g)}if(t!=="coil"&&b.ss==="coil"){h=Q}else{if(f&&b.ssbegin){h=Q}else{h=(t==="coil")?Q:u}}var n;if(b.name==="O"){n=l.clone();n.sub(d)}else{if(this.bCalphaOnly&&b.name==="CA"){n=new THREE.Vector3(Math.random(),Math.random(),Math.random())}}n.normalize();n.multiplyScalar(h);if(U!==null&&n.dot(U)<0){n.negate()}U=n;for(var ac=0,aa=2/(ag-1);ac<ag;++ac){var V=-1+aa*ac;var Y=new THREE.Vector3(d.x+U.x*V,d.y+U.y*V,d.z+U.z*V);if(!K&&t!=="coil"){Y.smoothen=true}X[ac].push(Y)}ae.push(d);T.push(U);if(G.hasOwnProperty(H)){F.push(true)}else{F.push(false)}++x}if((b.ssbegin||b.ssend||(x===p-1))&&X[0].length>0&&D){if(P===1||P===2){Z.push(this.highlightColor)}else{Z.push(b.color)}if(b.ssend&&b.ss==="sheet"){h=0}else{if(t==="coil"&&b.ssbegin){h=Q}else{if(f&&b.ssbegin){h=Q}else{h=(b.ss==="coil")?Q:u}}}var n;if(b.name==="O"){n=W.clone();n.sub(am)}else{if(this.bCalphaOnly&&b.name==="CA"){n=new THREE.Vector3(Math.random(),Math.random(),Math.random())}}n.normalize();n.multiplyScalar(h);if(U!==null&&n.dot(U)<0){n.negate()}U=n;for(var ac=0,aa=2/(ag-1);ac<ag;++ac){var V=-1+aa*ac;var Y=new THREE.Vector3(am.x+U.x*V,am.y+U.y*V,am.z+U.z*V);if(!K&&t!=="coil"){Y.smoothen=true}X[ac].push(Y)}ah=b.serial;ae.push(am);T.push(U);if(G.hasOwnProperty(ah)){F.push(true)}else{F.push(false)}for(var ac=0;!z&&ac<ag;++ac){if(ak){this.createCurveSubArrow(X[ac],1,Z,af,P,y,ag,ac,ae,T,F)}else{this.createCurveSub(X[ac],1,Z,af,P,y,false,F)}}if(z){if(ak){var J=0,B=ag-1;this.createStripArrow(X[0],X[ag-1],Z,af,C,P,ag,J,B,ae,T,F)}else{if(q){this.createStrip(X[0],X[ag-1],Z,af,C,P,false,F)}else{if(P===2){this.createStrip(X[0],X[ag-1],Z,af,C,P,false,F)}}}}for(var ab=0;ab<ag;++ab){X[ab]=[]}Z=[];ae=[];T=[];F=[];ak=false;q=false}if((E!==b.chain||R+1!==b.resi)&&X[0].length>0){for(var ac=0;!z&&ac<ag;++ac){if(ak){this.createCurveSubArrow(X[ac],1,Z,af,P,y,ag,ac,ae,T,F)}else{if(q){this.createCurveSub(X[ac],1,Z,af,P,y,false,F)}}}if(z){if(ak){var J=0,B=ag-1;this.createStripArrow(X[0],X[ag-1],Z,af,C,P,ag,J,B,ae,T,F)}else{if(q){this.createStrip(X[0],X[ag-1],Z,af,C,P,false,F)}}}for(var ab=0;ab<ag;++ab){X[ab]=[]}Z=[];ae=[];T=[];F=[];ak=false;q=false}E=b.chain;R=b.resi;t=b.ss;f=b.ssend;H=b.serial;d=am;l=b.coord;g=a}}}this.createTube(m,"CA",0.3,P)},createStrandBrick:function(x,p,a){var c=this.strandDIV;var l=this.axisDIV;var m=false;var e=this.helixSheetWidth;var t={};for(var q=0;q<c;++q){t[q]=[]}var d=[];var h=null,o=null;for(var u=0;u<2;++u){var f=x.coords[u];d.push(new THREE.Color(p));var b=new THREE.Vector3(x.coords[2].x,x.coords[2].y,x.coords[2].z);b.normalize();b.multiplyScalar(e);if(h!==null&&b.dot(h)<0){b.negate()}h=b;for(var r=0,n=2/(c-1);r<c;++r){var w=-1+n*r;var g=new THREE.Vector3(f.x+h.x*w,f.y+h.y*w,f.z+h.z*w);if(!m){g.smoothen=true}t[r].push(g)}}this.createStrip(t[0],t[c-1],d,l,a)},createTubeSub:function(b,h,m,E){if(b.length<2){return}var w=this.tubeDIV,g=this.axisDIV;var p=1/w,u=1/g;var H=new THREE.Geometry();var t=this.subdivide(b,g);var G=new THREE.Vector3(),F;for(var v=0,d=t.length;v<d;++v){var l,k=(v-1)*u;if(v===0){l=m[0]}else{if(k%1===0){l=m[k]}else{var I=Math.floor(k);var B=k-I;l=m[I]*B+m[I+1]*(1-B)}}var D,C,A;if(v<d-1){D=t[v].clone().sub(t[v+1]);C=new THREE.Vector3(0,-D.z,D.y).normalize().multiplyScalar(l);A=D.clone().cross(C).normalize().multiplyScalar(l);if(G.dot(C)<0){C.negate();A.negate()}G=C;F=A}else{C=G;A=F}for(var o=0;o<w;++o){var y=2*Math.PI*p*o;H.vertices.push(t[v].clone().add(C.clone().multiplyScalar(Math.cos(y))).add(A.clone().multiplyScalar(Math.sin(y))))}}var f=0;for(var v=0,d=t.length-1;v<d;++v){var x=v;if(v<g){x=g}var z=new THREE.Color(h[parseInt(x*u)]);var e=0;var q=H.vertices[f].clone().sub(H.vertices[f+w]).lengthSq();var n=H.vertices[f].clone().sub(H.vertices[f+w+1]).lengthSq();if(q>n){q=n;e=1}for(var o=0;o<w;++o){H.faces.push(new THREE.Face3(f+o,f+(o+e)%w+w,f+(o+1)%w,undefined,z));H.faces.push(new THREE.Face3(f+(o+1)%w,f+(o+e)%w+w,f+(o+e+1)%w+w,undefined,z))}f+=w}H.computeFaceNormals();H.computeVertexNormals(false);var a;if(E===2){a=new THREE.Mesh(H,new THREE.MeshPhongMaterial({transparent:true,opacity:0.5,metal:false,overdraw:this.overdraw,specular:this.fractionOfColor,shininess:30,emissive:0,vertexColors:THREE.FaceColors,side:THREE.DoubleSide}))}else{if(E===1){a=new THREE.Mesh(H,this.matShader)}else{a=new THREE.Mesh(H,new THREE.MeshPhongMaterial({metal:false,overdraw:this.overdraw,specular:this.fractionOfColor,shininess:30,emissive:0,vertexColors:THREE.FaceColors,side:THREE.DoubleSide}))}}this.mdl.add(a);if(E===1||E===2){this.prevHighlightObjects.push(a)}else{this.objects.push(a)}},createTube:function(g,k,j,l){var m=[],a=[],e=[];var b,f;for(var d in g){var h=g[d];if((h.name===k)&&!h.het){if(b!==h.chain||f+1!==h.resi){if(l!==2){this.createTubeSub(m,a,e,l)}m=[];a=[];e=[]}m.push(h.coord);e.push(j||(h.b>0?h.b*0.01:0.3));a.push(h.color);b=h.chain;f=h.resi;var c=1.2;if(l===2&&!h.ssbegin){this.createBox(h,undefined,undefined,c,undefined,l)}}}if(l!==2){this.createTubeSub(m,a,e,l)}},createCylinderHelix:function(f,h,j){var b=null;var a,e;var c={},k={};var d;for(d in f){var g=f[d];if(g.het){continue}if((g.ss!=="helix"&&g.ss!=="sheet")||g.ssend||g.ssbegin){c[g.serial]=g}if(g.ss==="sheet"){k[g.serial]=g}if(g.name!=="CA"){continue}if(g.ss==="helix"&&g.ssend){if(b!==null&&a===g.chain&&e<g.resi){if(j===1||j===2){this.createCylinder(b.coord,g.coord,h,this.highlightColor,j)}else{this.createCylinder(b.coord,g.coord,h,g.color)}}b=null}if(b===null&&g.ss==="helix"&&g.ssbegin){b=g;a=g.chain;e=g.resi}}if(j===1||j===2){if(Object.keys(c).length>0){this.createTube(c,"CA",0.3,j)}if(Object.keys(k).length>0){this.createStrand(k,undefined,undefined,true,0,this.helixSheetWidth,false,this.thickness*2,j)}}else{if(Object.keys(c).length>0){this.createTube(c,"CA",0.3)}if(Object.keys(k).length>0){this.createStrand(k,undefined,undefined,true,0,this.helixSheetWidth,false,this.thickness*2)}}},createSurfaceRepresentation:function(d,g,f,e){var c;var a=ProteinSurface({min:this.pmin,max:this.pmax,atoms:d,type:g});var h=a.verts;var b=a.faces;c=new THREE.Geometry();c.vertices=h.map(function(j){var k=new THREE.Vector3(j.x,j.y,j.z);k.atomid=j.atomid;return k});c.faces=b.map(function(j){return new THREE.Face3(j.a,j.b,j.c)});a=null;c.computeFaceNormals();c.computeVertexNormals(false);c.colorsNeedUpdate=true;c.faces.forEach(function(j){j.vertexColors=["a","b","c"].map(function(k){return d[c.vertices[j[k]].atomid].color})});var i=new THREE.Mesh(c,new THREE.MeshLambertMaterial({overdraw:this.overdraw,vertexColors:THREE.VertexColors,wireframe:f,opacity:e,transparent:true,}));this.mdl.add(i)},drawNucleicAcidStick:function(g,e){var b,c,h=null,a=null;var d;for(d in g){var f=g[d];if(f===undefined||f.het){continue}if(f.resi!==c||f.chain!==b){if(h!==null&&a!==null){this.createCylinder(new THREE.Vector3(h.coord.x,h.coord.y,h.coord.z),new THREE.Vector3(a.coord.x,a.coord.y,a.coord.z),0.3,h.color,e)}h=null;a=null}if(f.name==="O3'"){h=f}if(f.resn==="  A"||f.resn==="  G"||f.resn===" DA"||f.resn===" DG"){if(f.name==="N1"){a=f}}else{if(f.name==="N3"){a=f}}c=f.resi;b=f.chain}if(h!==null&&a!==null){this.createCylinder(new THREE.Vector3(h.coord.x,h.coord.y,h.coord.z),new THREE.Vector3(a.coord.x,a.coord.y,a.coord.z),0.3,h.color,e)}},drawCartoonNucleicAcid:function(c,d,a,b){this.drawStrandNucleicAcid(c,2,d,true,undefined,a,b)},drawStrandNucleicAcid:function(n,e,l,p,h,a,w){if(w===2){e=undefined;a=undefined}h=h||this.nucleicAcidWidth;l=l||this.axisDIV;e=e||this.nucleicAcidStrandDIV;var t,q,o;var r=[];for(o=0;o<e;o++){r[o]=[]}var g=[];var f,c,u;var m=null;for(t in n){var b=n[t];if(b===undefined){continue}if((b.name==="O3'"||b.name==="OP2")&&!b.het){if(b.name==="O3'"){if(f!==b.chain||c+1!==b.resi){if(u&&m){for(q=0;q<e;q++){var v=-1+2/(e-1)*q;r[q].push(new THREE.Vector3(u.x+m.x*v,u.y+m.y*v,u.z+m.z*v))}}if(p){this.createStrip(r[0],r[1],g,l,a,w)}for(q=0;!a&&q<e;q++){this.createCurveSub(r[q],1,g,l,w)}var r=[];for(o=0;o<e;o++){r[o]=[]}g=[];m=null}u=new THREE.Vector3(b.coord.x,b.coord.y,b.coord.z);f=b.chain;c=b.resi;if(w===1||w===2){g.push(this.highlightColor)}else{g.push(b.color)}}else{if(!u){m=null;continue}var d=new THREE.Vector3(b.coord.x,b.coord.y,b.coord.z);d.sub(u);d.normalize().multiplyScalar(h);if(m!==null&&d.dot(m)<0){d.negate()}m=d;for(q=0;q<e;q++){var v=-1+2/(e-1)*q;r[q].push(new THREE.Vector3(u.x+m.x*v,u.y+m.y*v,u.z+m.z*v))}u=null}}}if(u&&m){for(q=0;q<e;q++){var v=-1+2/(e-1)*q;r[q].push(new THREE.Vector3(u.x+m.x*v,u.y+m.y*v,u.z+m.z*v))}}if(p){this.createStrip(r[0],r[1],g,l,a,w)}for(q=0;!a&&q<e;q++){this.createCurveSub(r[q],1,g,l,w)}},drawSymmetryMates2:function(){if(this.biomtMatrices===undefined){return}var c=1;var k=this.center.clone();for(var f=0;f<this.biomtMatrices.length;f++){var h=this.biomtMatrices[f];if(h===undefined){continue}var b=h.toArray();var e=1;for(var d in b){if(d==0||d==5||d==10){if(parseInt(1000*b[d])!=1000){e=0}}else{if(d!=0&&d!=5&&d!=10&&d!=15){if(parseInt(1000*b[d])!=0){e=0}}}}if(e){continue}var g=this.mdl.clone();g.applyMatrix(h);var a=this.center.clone();a.applyMatrix4(h);k.add(a);this.mdl.add(g);++c}this.maxD*=Math.sqrt(c);this.mdl.position.add(this.center).sub(k.multiplyScalar(1/c));this.setCamera()},makeTextSprite:function(l,k){if(k===undefined){k={}}var q=k.hasOwnProperty("fontface")?k.fontface:"Arial";var t=k.hasOwnProperty("fontsize")?k.fontsize:18;var d=k.hasOwnProperty("borderThickness")?k.borderThickness:4;var u=1;var c=k.hasOwnProperty("borderColor")?this.hexToRgb(k.borderColor,u):{r:0,g:0,b:0,a:1};var j=k.hasOwnProperty("backgroundColor")?this.hexToRgb(k.backgroundColor,u):{r:0,g:0,b:0,a:0.5};u=1;var h=k.hasOwnProperty("textColor")?this.hexToRgb(k.textColor,u):{r:255,g:255,b:0,a:1};var g=document.createElement("canvas");var e=g.getContext("2d");e.font="Bold "+t+"px "+q;var p=e.measureText(l);var f=p.width;var i=e.measureText("M").width;e.fillStyle="rgba("+j.r+","+j.g+","+j.b+","+j.a+")";e.strokeStyle="rgba("+c.r+","+c.g+","+c.b+","+c.a+")";e.lineWidth=d;this.roundRect(e,d/2,d/2,(f+d)*1.1,t*1.4+d,i*0.3);e.fillStyle="rgba("+h.r+", "+h.g+", "+h.b+", 1.0)";e.strokeStyle="rgba("+h.r+", "+h.g+", "+h.b+", 1.0)";e.fillText(l,d+t*0.1,t+d);var m=new THREE.Texture(g);m.needsUpdate=true;var b=true;var r=new THREE.SpriteMaterial({map:m,useScreenCoordinates:false,depthTest:!b,depthWrite:!b});var o=new THREE.Sprite(r);var n=this.maxD/100;o.scale.set(16*n,8*n,1);return o},hexToRgb:function(d,c){var b=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(d);return b?{r:parseInt(b[1],16),g:parseInt(b[2],16),b:parseInt(b[3],16),a:c}:null},roundRect:function(c,a,f,b,d,e){c.beginPath();c.moveTo(a+e,f);c.lineTo(a+b-e,f);c.quadraticCurveTo(a+b,f,a+b,f+e);c.lineTo(a+b,f+d-e);c.quadraticCurveTo(a+b,f+d,a+b-e,f+d);c.lineTo(a+e,f+d);c.quadraticCurveTo(a,f+d,a,f+d-e);c.lineTo(a,f+e);c.quadraticCurveTo(a,f,a+e,f);c.closePath();c.fill();c.stroke()},createLabelRepresentation:function(g){for(var e in g){var c=g[e];var d=(c.size)?c.size:this.LABELSIZE;var a=(c.color)?c.color:"#ffff00";var b=(c.background)?c.background:"#cccccc";var f=this.makeTextSprite(c.text,{fontsize:parseInt(d),textColor:a,borderColor:b,backgroundColor:b});f.position.set(c.position.x,c.position.y,c.position.z);this.mdl.add(f)}},getAtomsWithinAtom:function(k,l,a){var f;var n=this.getExtent(l);var d=(n[2][0]-n[0][0])*(n[2][0]-n[0][0])+(n[2][1]-n[0][1])*(n[2][1]-n[0][1])+(n[2][2]-n[0][2])*(n[2][2]-n[0][2]);var b=(n[2][0]-n[1][0])*(n[2][0]-n[1][0])+(n[2][1]-n[1][1])*(n[2][1]-n[1][1])+(n[2][2]-n[1][2])*(n[2][2]-n[1][2]);var g=(d>b)?d:b;var c=Math.sqrt(g);var m=(c+a)*(c+a);var j={};for(f in k){var h=k[f];if(h.coord.x<n[0][0]-a||h.coord.x>n[1][0]+a){continue}if(h.coord.y<n[0][1]-a||h.coord.y>n[1][1]+a){continue}if(h.coord.z<n[0][2]-a||h.coord.z>n[1][2]+a){continue}if(h.serial in l){continue}var e=(h.coord.x-n[2][0])*(h.coord.x-n[2][0])+(h.coord.y-n[2][1])*(h.coord.y-n[2][1])+(h.coord.z-n[2][2])*(h.coord.z-n[2][2]);if(e<m){j[h.serial]=h}}return j},getExtent:function(f){var d=ymin=zmin=9999;var a=ymax=zmax=-9999;var e=ysum=zsum=cnt=0;var b;for(b in f){var c=f[b];cnt++;e+=c.coord.x;ysum+=c.coord.y;zsum+=c.coord.z;d=(d<c.coord.x)?d:c.coord.x;ymin=(ymin<c.coord.y)?ymin:c.coord.y;zmin=(zmin<c.coord.z)?zmin:c.coord.z;a=(a>c.coord.x)?a:c.coord.x;ymax=(ymax>c.coord.y)?ymax:c.coord.y;zmax=(zmax>c.coord.z)?zmax:c.coord.z}return[[d,ymin,zmin],[a,ymax,zmax],[e/cnt,ysum/cnt,zsum/cnt]]},getAtomsFromPosition:function(b,a){var c,d;if(a===undefined||a===null){a=1}for(c in this.atoms){var d=this.atoms[c];if(d.coord.x<b.x-a||d.coord.x>b.x+a){continue}if(d.coord.y<b.y-a||d.coord.y>b.y+a){continue}if(d.coord.z<b.z-a||d.coord.z>b.z+a){continue}return d}return null},buildAxes:function(a){var b=new THREE.Object3D();b.add(this.createSingleLine(new THREE.Vector3(0,0,0),new THREE.Vector3(0+a,0,0),16711680,false,0.5));b.add(this.createSingleLine(new THREE.Vector3(0,0,0),new THREE.Vector3(0-a,0,0),8388608,true,0.5));b.add(this.createSingleLine(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0+a,0),65280,false,0.5));b.add(this.createSingleLine(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0-a,0),32768,true,0.5));b.add(this.createSingleLine(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0+a),255,false,0.5));b.add(this.createSingleLine(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0-a),128,true,0.5));this.scene.add(b)},createSingleLine:function(g,h,c,b,a){var e=new THREE.Geometry();var d;if(b){d=new THREE.LineDashedMaterial({linewidth:1,color:c,dashSize:a,gapSize:a})}else{d=new THREE.LineBasicMaterial({linewidth:1,color:c})}e.vertices.push(g);e.vertices.push(h);if(b){e.computeLineDistances()}var f=new THREE.Line(e,d,THREE.LinePieces);return f},intersectHash:function(b,a){var d={};if(Object.keys(b).length<Object.keys(a).length){for(var c in b){if(a!==undefined&&a[c]){d[c]=b[c]}}}else{for(var c in a){if(b!==undefined&&b[c]){d[c]=a[c]}}}return d},excludeHash:function(d,a){var c={};for(var b in d){if(!(b in a)){c[b]=d[b]}}return c},unionHash:function(b,a){return jQuery.extend({},b,a)},intersectHash2Atoms:function(b,a){return this.hash2Atoms(this.intersectHash(b,a))},excludeHash2Atoms:function(b,a){return this.hash2Atoms(this.excludeHash(b,a))},unionHash2Atoms:function(b,a){return this.hash2Atoms(this.unionHash(b,a))},hash2Atoms:function(c){var a={};for(var b in c){a[b]=this.atoms[b]}return a},centerAtoms:function(f){var a=new THREE.Vector3(9999,9999,9999);var e=new THREE.Vector3(-9999,-9999,-9999);var c=new THREE.Vector3();var b=0;for(var d in f){var h=this.atoms[d];var g=h.coord;c.add(g);a.min(g);e.max(g);++b}var j=e.distanceTo(a);return{center:c.multiplyScalar(1/b),maxD:j}},exportCanvas:function(){this.render();window.open(this.renderer.domElement.toDataURL("image/png"))},applyPrevColor:function(){for(var a in this.atoms){var b=this.atoms[a];b.color=this.atomPrevColors[a]}},setColorByOptions:function(n,f,d){if(d!==undefined&&d){for(var e in f){var g=this.atoms[e];this.atomPrevColors[e]=g.color}}else{if(n.color.indexOf("#")===0){for(var e in f){var g=this.atoms[e];g.color=new THREE.Color().setStyle(n.color.toLowerCase());this.atomPrevColors[e]=g.color}}else{switch(n.color.toLowerCase()){case"spectrum":var m=0;var l=1/this.cnt;for(var e in f){var g=this.atoms[e];g.color=g.het?this.atomColors[g.elem]||this.defaultAtomColor:new THREE.Color().setHSL(2/3*(1-m++*l),1,0.45);this.atomPrevColors[e]=g.color}break;case"chain":var h=-1,k="",j=this.stdChainColors.length;for(var e in f){var g=this.atoms[e];if(g.chain!=k){++h;h=h%j}g.color=this.stdChainColors[h];if(Object.keys(this.chainsColor).length>0){this.updateChainsColor(g)}this.atomPrevColors[e]=g.color;k=g.chain}break;case"secondary structure":for(var e in f){var g=this.atoms[e];g.color=g.het?this.atomColors[g.elem]||this.defaultAtomColor:this.ssColors[g.ss];this.atomPrevColors[e]=g.color}break;case"B factor":var c=this.getFirstAtomObj(this.atoms);if(!this.middB&&c.b!==undefined){var b=1000,a=-1000;for(var e in f){var g=this.atoms[e];if(b>parseFloat(g.b)){b=parseFloat(g.b)}if(a<parseFloat(g.b)){a=parseFloat(g.b)}}this.middB=(a+b)*0.5;this.spanB=(a-b)*0.5;this.spanBinv=1/this.spanB}for(var e in f){var g=this.atoms[e];if(g.b!==undefined&&this.middB!==undefined){g.color=g.b<this.middB?new THREE.Color().setRGB(1-(s=(this.middB-g.b)*this.spanBinv),1-s,1):new THREE.Color().setRGB(1,1-(s=(g.b-this.middB)*this.spanBinv),1-s)}this.atomPrevColors[e]=g.color}break;case"residue":for(var e in f){var g=this.atoms[e];g.color=g.het?this.atomColors[g.elem]||this.defaultAtomColor:this.residueColors[g.resn]||this.defaultResidueColor;this.atomPrevColors[e]=g.color}break;case"polarity":for(var e in f){var g=this.atoms[e];g.color=g.het?this.atomColors[g.elem]||this.defaultAtomColor:this.polarityColors[g.resn]||this.defaultResidueColor;this.atomPrevColors[e]=g.color}break;case"atom":for(var e in f){var g=this.atoms[e];g.color=this.atomColors[g.elem]||this.defaultAtomColor;this.atomPrevColors[e]=g.color}break;case"white":for(var e in f){var g=this.atoms[e];g.color=new THREE.Color().setHex(16777215);if(Object.keys(this.chainsColor).length>0){this.updateChainsColor(g)}this.atomPrevColors[e]=g.color}break;case"grey":for(var e in f){var g=this.atoms[e];g.color=new THREE.Color().setHex(8947848);if(Object.keys(this.chainsColor).length>0){this.updateChainsColor(g)}this.atomPrevColors[e]=g.color}break;case"red":for(var e in f){var g=this.atoms[e];g.color=new THREE.Color().setHex(16711680);if(Object.keys(this.chainsColor).length>0){this.updateChainsColor(g)}this.atomPrevColors[e]=g.color}break;case"green":for(var e in f){var g=this.atoms[e];g.color=new THREE.Color().setHex(65280);if(Object.keys(this.chainsColor).length>0){this.updateChainsColor(g)}this.atomPrevColors[e]=g.color}break;case"blue":for(var e in f){var g=this.atoms[e];g.color=new THREE.Color().setHex(255);if(Object.keys(this.chainsColor).length>0){this.updateChainsColor(g)}this.atomPrevColors[e]=g.color}break;case"magenta":for(var e in f){var g=this.atoms[e];g.color=new THREE.Color().setHex(16711935);if(Object.keys(this.chainsColor).length>0){this.updateChainsColor(g)}this.atomPrevColors[e]=g.color}break;case"yellow":for(var e in f){var g=this.atoms[e];g.color=new THREE.Color().setHex(16776960);if(Object.keys(this.chainsColor).length>0){this.updateChainsColor(g)}this.atomPrevColors[e]=g.color}break;case"cyan":for(var e in f){var g=this.atoms[e];g.color=new THREE.Color().setHex(65535);if(Object.keys(this.chainsColor).length>0){this.updateChainsColor(g)}this.atomPrevColors[e]=g.color}break;case"custom":break}}}},updateChainsColor:function(b){var a=b.structure+"_"+b.chain;if(this.chainsColor[a]!==undefined){this.chainsColor[a]=b.color}},applyOptions:function(d){if(d===undefined){d=this.options}this.applyDisplayOptions(d,this.displayAtoms);if(d.labels.toLowerCase()==="yes"){this.createLabelRepresentation(this.labels)}if(d.lines.toLowerCase()==="yes"){this.createLines(this.lines)}if(d.hbonds.toLowerCase()==="yes"){var c="#FFFFFF";if(d.background.toLowerCase()!=="black"){c="#000000"}for(var e=0,h=Math.floor(this.hbondpoints.length/2);e<h;e++){var g=this.hbondpoints[2*e],f=this.hbondpoints[2*e+1];var b={};b.position1=this.hbondpoints[2*e];b.position2=this.hbondpoints[2*e+1];b.color=c;b.dashed=true;this.lines.push(b)}this.createLines(this.lines)}switch(d.rotationcenter.toLowerCase()){case"molecule center":if(this.center!==undefined){this.mdl.position.sub(this.center)}break;case"pick center":if(this.pickedatom!==undefined){this.mdl.position.sub(this.pickedatom.coord)}break;case"display center":var a=this.centerAtoms(this.displayAtoms).center;this.mdl.position.sub(a);break;case"highlight center":var a=this.centerAtoms(this.highlightAtoms).center;this.mdl.position.sub(a);break}switch(d.axis.toLowerCase()){case"yes":this.axis=true;this.buildAxes(this.maxD/2);break;case"no":this.axis=false;break}switch(d.picking.toLowerCase()){case"atom":this.picking=1;break;case"no":this.picking=0;break;case"residue":this.picking=2;break}},drawHelixBrick:function(c,k){for(var b in c){for(var e=0,g=c[b].length;e<g;++e){if(c[b][e].type==="helix"){var i=1.6;var d=new THREE.Color(k[b]);var n=new THREE.Vector3(c[b][e].coords[0].x,c[b][e].coords[0].y,c[b][e].coords[0].z);var m=new THREE.Vector3(c[b][e].coords[1].x,c[b][e].coords[1].y,c[b][e].coords[1].z);this.createCylinder(n,m,i,d)}else{if(c[b][e].type==="brick"){var h=c[b][e];var d=k[b];this.createStrandBrick(h,d,this.thickness)}else{if(c[b][e].type==="coil"){var l=[],a=[],f=[];var n=new THREE.Vector3(c[b][e].coords[0].x,c[b][e].coords[0].y,c[b][e].coords[0].z);var m=new THREE.Vector3(c[b][e].coords[1].x,c[b][e].coords[1].y,c[b][e].coords[1].z);var d=new THREE.Color(k[b]);var o=this.createSingleLine(n,m,d,false);this.mdl.add(o);this.objects.push(o)}}}}}},applyDisplayOptions:function(c,d,u){if(c===undefined){c=this.options}var v={};var k={};var q={};var h;if(u===1){q=this.hash2Atoms(d);for(var r in q){var b=q[r];h=b.structure+"_"+b.chain+"_"+b.resi;v[h]=1}for(var r in v){var l=r.lastIndexOf("_");var f=r.substr(0,l+1);var j=parseInt(r.substr(l+1));var a=f+(j-1).toString();var e=f+(j+1).toString();if(!v.hasOwnProperty(a)&&!v.hasOwnProperty(a)){k[r]=1}}if(Object.keys(q).length===1&&Object.keys(this.residues[h]).length>1&&q[Object.keys(q)[0]].style!=="sphere"&&q[Object.keys(q)[0]].style!=="dot"){if(this.bCid===undefined||!this.bCid){for(var r in q){var b=q[r];var w=1;this.createBox(b,undefined,undefined,w,undefined,u)}}}else{for(var h in k){var b=this.getFirstAtomObj(this.residues[h]);var a=b.structure+"_"+b.chain+"_"+parseInt(b.resi-1);var e=b.structure+"_"+b.chain+"_"+parseInt(b.resi+1);if(b.style==="cylinder & plate"&&b.ss==="helix"){for(var r in this.residues[h]){var b=this.atoms[r];var w=1;this.createBox(b,undefined,undefined,w,undefined,u)}}else{if((b.style==="ribbon"&&b.ss==="coil")||(b.style==="strand"&&b.ss==="coil")||b.style==="phosphorus trace"||b.style==="C alpha trace"||b.style==="B factor tube"||(b.style==="cylinder & plate"&&b.ss!=="helix")){var o=false;if(!o&&this.residues.hasOwnProperty(e)){var g=Object.keys(this.residues[e])[0];var m=this.hash2Atoms(this.residues[e])[g];if((b.style===m.style&&!m.ssbegin)||m.ssbegin){var p=this.residues[e];d=this.unionHash(d,p);o=true;if(m.ssbegin){for(var r in p){this.atoms[r].notshow=true}}}}if(!o&&this.residues.hasOwnProperty(a)){var g=Object.keys(this.residues[a])[0];var m=this.hash2Atoms(this.residues[a])[g];if(b.style===m.style){d=this.unionHash(d,this.residues[a]);o=true}}}else{if((b.style==="ribbon"&&b.ss!=="coil"&&b.ssend)||(b.style==="strand"&&b.ss!=="coil"&&b.ssend)){var o=false;if(!o&&this.residues.hasOwnProperty(e)){var g=Object.keys(this.residues[e])[0];var m=this.hash2Atoms(this.residues[e])[g];d=this.unionHash(d,this.residues[e]);o=true}}}}}}}this.setStyle2Atoms(d);for(var t in this.style2atoms){atomHash=this.style2atoms[t];if(t==="ribbon"){this.createStrand(this.hash2Atoms(atomHash),2,undefined,true,undefined,undefined,false,this.thickness,u)}else{if(t==="strand"){this.createStrand(this.hash2Atoms(atomHash),null,null,null,null,null,false,undefined,u)}else{if(t==="cylinder & plate"){this.createCylinderHelix(this.hash2Atoms(atomHash),1.6,u)}else{if(t==="nucleotide cartoon"){this.drawCartoonNucleicAcid(this.hash2Atoms(atomHash),null,this.thickness,u);if(u!==2){this.drawNucleicAcidStick(this.hash2Atoms(atomHash),u)}}else{if(t==="phosphorus trace"){this.createCylinderCurve(this.hash2Atoms(atomHash),"P",0.2,false,u)}else{if(t==="phosphorus lines"){this.createCylinderCurve(this.hash2Atoms(atomHash),"P",0.2,true,u)}else{if(t==="C alpha trace"){this.createCylinderCurve(this.hash2Atoms(atomHash),"CA",0.2,false,u)}else{if(t==="B factor tube"){this.createTube(this.hash2Atoms(atomHash),"CA",null,u)}else{if(t==="lines"){if(u===1){this.createStickRepresentation(this.hash2Atoms(atomHash),0.1,0.1,undefined,u)}else{this.createLineRepresentation(this.hash2Atoms(atomHash),u)}}else{if(t==="stick"){this.createStickRepresentation(this.hash2Atoms(atomHash),this.cylinderRadius,this.cylinderRadius,undefined,u)}else{if(t==="ball & stick"){this.createStickRepresentation(this.hash2Atoms(atomHash),this.cylinderRadius,this.cylinderRadius*0.5,0.3,u)}else{if(t==="sphere"){this.createSphereRepresentation(this.hash2Atoms(atomHash),this.sphereRadius,undefined,undefined,u)}else{if(t==="dot"){this.createSphereRepresentation(this.hash2Atoms(atomHash),this.sphereRadius,false,0.3,u)}}}}}}}}}}}}}}switch(c.wireframe){case"yes":c.wireframe=true;break;case"no":c.wireframe=false;break}c.opacity=parseFloat(c.opacity);if(c.showsurface.toLowerCase()==="yes"){var n={};n=this.hash2Atoms(this.highlightAtoms);switch(c.surface.toLowerCase()){case"van der waals surface":this.createSurfaceRepresentation(n,1,c.wireframe,c.opacity);break;case"solvent excluded surface":this.createSurfaceRepresentation(n,2,c.wireframe,c.opacity);break;case"solvent accessible surface":this.createSurfaceRepresentation(n,3,c.wireframe,c.opacity);break;case"molecular surface":this.createSurfaceRepresentation(n,4,c.wireframe,c.opacity);break}}},setStyle2Atoms:function(a){this.style2atoms={};for(var b in a){if(this.style2atoms[this.atoms[b].style]===undefined){this.style2atoms[this.atoms[b].style]={}}this.style2atoms[this.atoms[b].style][b]=1}},setAtomStyleByOptions:function(a){if(a.sidechains!==undefined){for(var b in this.peptides){this.atoms[b].style=a.sidechains.toLowerCase()}}if(a.secondary!==undefined){for(var b in this.peptides){this.atoms[b].style=a.secondary.toLowerCase()}}if(a.ligands!==undefined){for(var b in this.ligands){this.atoms[b].style=a.ligands.toLowerCase()}}if(a.ions!==undefined){for(var b in this.ions){this.atoms[b].style=a.ions.toLowerCase()}}if(a.water!==undefined){for(var b in this.water){this.atoms[b].style=a.water.toLowerCase()}}if(a.nucleotides!==undefined){for(var b in this.nucleotides){this.atoms[b].style=a.nucleotides.toLowerCase()}}},rebuildScene:function(b){jQuery.extend(this.options,b);this.scene=new THREE.Scene();this.directionalLight=new THREE.DirectionalLight(16777215,1.2);if(this.camera_z>0){this.directionalLight.position.set(0,0,1)}else{this.directionalLight.position.set(0,0,-1)}var a=new THREE.AmbientLight(2105376);this.scene.add(this.directionalLight);this.scene.add(a);this.mdl=new THREE.Object3D();this.scene.add(this.mdl);this.objects=[];this.raycaster=new THREE.Raycaster();this.projector=new THREE.Projector();this.mouse=new THREE.Vector2();var c=this.backgroundColors[this.options.background.toLowerCase()];this.renderer.setClearColor(c);this.perspectiveCamera=new THREE.PerspectiveCamera(20,this.container.whratio,0.1,10000);this.perspectiveCamera.position.set(0,0,this.camera_z);this.perspectiveCamera.lookAt(new THREE.Vector3(0,0,0));this.orthographicCamera=new THREE.OrthographicCamera();this.orthographicCamera.position.set(0,0,this.camera_z);this.orthographicCamera.lookAt(new THREE.Vector3(0,0,0));this.cameras={perspective:this.perspectiveCamera,orthographic:this.orthographicCamera,};this.setCamera();this.applyOptions(this.options)},setCamera:function(){this.camera=this.cameras[this.options.camera.toLowerCase()];if(this.camera===this.perspectiveCamera){if(this.camera_z>0){this.camera.position.z=this.maxD*2}else{this.camera.position.z=-this.maxD*2}this.controls=new THREE.TrackballControls(this.camera,document.getElementById(this.id),this)}else{if(this.camera===this.orthographicCamera){this.camera.right=this.maxD/2*2.5;this.camera.left=-this.camera.right;this.camera.top=this.camera.right/this.container.whratio;this.camera.bottom=-this.camera.right/this.container.whratio;if(this.camera_z>0){this.camera.near=10000;this.camera.far=-10000}else{this.camera.near=-10000;this.camera.far=10000}this.controls=new THREE.OrthographicTrackballControls(this.camera,document.getElementById(this.id),this)}}this.camera.updateProjectionMatrix()},applyTransformation:function(b,d,c){var a={};a.update=false;a._zoomFactor=b;a.mouseChange=new THREE.Vector2();a.mouseChange.copy(d);a.quaternion=new THREE.Quaternion();a.quaternion.copy(c);this.controls.update(a)},render:function(){this.directionalLight.position.copy(this.camera.position);this.renderer.gammaInput=true;this.renderer.gammaOutput=true;this.renderer.setPixelRatio(window.devicePixelRatio);this.renderer.render(this.scene,this.camera)},setRotationCenter:function(a){this.mdl.position.sub(a)},draw:function(a,b){this.rebuildScene(a);if(b===undefined||b){this.applyPrevColor()}if(this.bSSOnly){this.drawHelixBrick(this.molid2ss,this.molid2color)}if(this.bAssembly){this.drawSymmetryMates2()}if(this.highlightAtoms!==undefined&&Object.keys(this.highlightAtoms).length>0&&Object.keys(this.highlightAtoms).length<Object.keys(this.displayAtoms).length){this.removeHighlightObjects();this.addHighlightObjects(undefined,undefined)}if(this.bRender===true){this.applyTransformation(this._zoomFactor,this.mouseChange,this.quaternion);this.render()}},zoomIn:function(b){var a={};a._zoomFactor=1-b;a.update=true;this.controls.update(a);this.render()},zoomOut:function(b){var a={};a._zoomFactor=1+b;a.update=true;this.controls.update(a);this.render()},rotateLeft:function(d){var b=new THREE.Vector3(0,1,0);var e=-d/180*Math.PI;b.applyQuaternion(this.camera.quaternion).normalize();var c=new THREE.Quaternion();c.setFromAxisAngle(b,-e);var a={};a.quaternion=c;a.update=true;this.controls.update(a);this.render()},rotateRight:function(d){var b=new THREE.Vector3(0,1,0);var e=d/180*Math.PI;b.applyQuaternion(this.camera.quaternion).normalize();var c=new THREE.Quaternion();c.setFromAxisAngle(b,-e);var a={};a.quaternion=c;a.update=true;this.controls.update(a);this.render()},rotateUp:function(d){var b=new THREE.Vector3(1,0,0);var e=-d/180*Math.PI;b.applyQuaternion(this.camera.quaternion).normalize();var c=new THREE.Quaternion();c.setFromAxisAngle(b,-e);var a={};a.quaternion=c;a.update=true;this.controls.update(a);this.render()},rotateDown:function(d){var b=new THREE.Vector3(1,0,0);var e=d/180*Math.PI;b.applyQuaternion(this.camera.quaternion).normalize();var c=new THREE.Quaternion();c.setFromAxisAngle(b,-e);var a={};a.quaternion=c;a.update=true;this.controls.update(a);this.render()},translateLeft:function(b){var c=new THREE.Vector2(0,0);c.x-=b/100;var a={};a.mouseChange=c;a.update=true;this.controls.update(a);this.render()},translateRight:function(b){var c=new THREE.Vector2(0,0);c.x+=b/100;var a={};a.mouseChange=c;a.update=true;this.controls.update(a);this.render()},translateUp:function(b){var c=new THREE.Vector2(0,0);c.y-=b/100;var a={};a.mouseChange=c;a.update=true;this.controls.update(a);this.render()},translateDown:function(b){var c=new THREE.Vector2(0,0);c.y+=b/100;var a={};a.mouseChange=c;a.update=true;this.controls.update(a);this.render()},showPicking:function(d){this.removeHighlightObjects();this.highlightAtoms={};if(this.picking===1){this.highlightAtoms[d.serial]=1}else{if(this.picking===2){var c=d.structure+"_"+d.chain+"_"+d.resi;this.highlightAtoms=this.residues[c]}}this.addHighlightObjects();var a="."+d.chain+":"+d.resi;var e=a+"@"+d.name;var f=[];var b={};b.position=d.coord;if(this.picking===1){b.text=e}else{if(this.picking===2){b.text=a}}f.push(b);this.createLabelRepresentation(f)},removeHighlightObjects:function(){for(var a in this.prevHighlightObjects){this.mdl.remove(this.prevHighlightObjects[a])}this.prevHighlightObjects=[];this.render()},addHighlightObjects:function(a){if(a===undefined){a=this.highlightColor}this.applyDisplayOptions(this.options,this.intersectHash(this.highlightAtoms,this.displayAtoms),this.bHighlight);this.render()},zoominSelection:function(){if(Object.keys(this.highlightAtoms).length>1){var a=this.centerAtoms(this.hash2Atoms(this.highlightAtoms));this.maxD=a.maxD;if(this.maxD<25){this.maxD=25}this.mdl.position.add(this.center).sub(a.center);this.center=a.center;this.setCamera()}this.render()}};
/*! simple_ui.js
 * simple UI
 */
var show3DStructure=function(g){var f=g.divid;var p=f+"_";var d=30;iCn3D.prototype.showPicking=function(z){this.removeHighlightObjects();this.highlightAtoms={};if(this.picking===1){this.highlightAtoms[z.serial]=1}else{if(this.picking===2){var y=z.structure+"_"+z.chain+"_"+z.resi;this.highlightAtoms=this.residues[y]}}this.addHighlightObjects();var w="."+z.chain+":"+z.resi;var A;if(g.cid!==undefined){A=z.name}else{A=w+"@"+z.name}var B=[];var x={};x.position=z.coord;if(this.picking===1){x.text=A}else{if(this.picking===2){x.text=w}}B.push(x);this.createLabelRepresentation(B)};var j="";j+="<div id='"+p+"viewer' style='position:relative; width:100%; height:100%;'>";j+="<!--div style='height:18px'></div-->";j+="<div id='"+p+"wait' style='width:100%; height: 100%; background-color: rgba(0,0,0, 0.8);'><div style='padding-top:25%; text-align: center; font-size: 2em; color: #FFFF00;'>Loading the structure...</div></div>";j+="<canvas id='"+p+"canvas' style='width:100%; height:100%;'>Your browser does not support WebGL.</canvas>";j+="<div class='tabBox' id='"+p+"toolbox'>";j+="<span class='bottomTab'>Tools</span>";j+="<div class='insideTab' style='overflow: auto;'>";j+="<form action='' id='"+p+"paraform' method='POST'>";if(g.cid===undefined){j+="<div class='option'>";j+="<b>&nbsp;&nbsp;Secondary Structure</b>";j+="<select id='"+p+"secondary'>";j+="<option value='ribbon' selected>ribbon</option>";j+="<option value='strand'>strand</option>";j+="<option value='cylinder & plate'>cylinder and plate</option>";j+="<option value='C alpha trace'>C alpha trace</option>";j+="<option value='B factor tube'>B factor tube</option>";j+="<option value='lines'>lines</option>";j+="<option value='stick'>stick</option>";j+="<option value='ball & stick'>ball and stick</option>";j+="<option value='sphere'>sphere</option>";j+="<option value='nothing'>hide</option>";j+="</select>";j+="</div>";j+="<div class='option'>";j+="<b>&nbsp;&nbsp;Nucleotides</b>";j+="<select id='"+p+"nucleotides'>";j+="<option value='nucleotide cartoon'>cartoon</option>";j+="<option value='phosphorus trace' selected>phosphorus trace</option>";j+="<option value='lines'>lines</option>";j+="<option value='stick'>stick</option>";j+="<option value='ball & stick'>ball and stick</option>";j+="<option value='sphere'>sphere</option>";j+="<option value='nothing'>hide</option>";j+="</select>";j+="</div>"}j+="<div class='option'>";j+="<b>&nbsp;&nbsp;Ligands</b>";j+="<select id='"+p+"ligands'>";j+="<option value='lines'>lines</option>";j+="<option value='stick' selected>stick</option>";j+="<option value='ball & stick'>ball and stick</option>";j+="<option value='sphere'>sphere</option>";j+="<option value='nothing'>hide</option>";j+="</select>";j+="</div>";j+="<div class='option'>";j+="<b>&nbsp;&nbsp;Color</b>";j+="<select id='"+p+"color'>";if(g.cid===undefined){j+="<option value='spectrum' selected>spectrum</option>";j+="<option value='chain'>chain</option>";j+="<option value='secondary structure'>secondary structure</option>";j+="<option value='B factor'>B factor</option>";j+="<option value='residue'>residue</option>";j+="<option value='polarity'>polarity</option>"}j+="<option value='atom'>atom</option>";j+="<option value='red'>red</option>";j+="<option value='green'>green</option>";j+="<option value='blue'>blue</option>";j+="<option value='magenta'>magenta</option>";j+="<option value='yellow'>yellow</option>";j+="<option value='cyan'>cyan</option>";j+="</select>";j+="</div>";j+="<div class='option'>";j+="&nbsp;&nbsp;<button class='enablepick'>Picking</button> <button class='disablepick'>No Picking</button>";j+="</div>";j+="<div class='option'>";j+="&nbsp;&nbsp;<button id='"+p+"reset'>Reset</button>";j+="</div>";j+="</form>";j+="</div>";j+="</div>";j+="</div>";j+="<!-- dialog will not be part of the form -->";j+="<div id='"+p+"allselections' class='hidden'>";j+="<div id='"+p+"dl_filter' style='overflow:auto; position:relative'>";j+="  <div style='text-align:center; margin-bottom:10px;'><button id='"+p+"filter'><span style='white-space:nowrap'><b>Show Structure</b></span></button>";j+="<button id='"+p+"label_3d_diagram' style='margin-left:10px;'><span style='white-space:nowrap'><b>Show Labels</b></span></button></div>";j+="  <div id='"+p+"dl_filter_table' class='box'>";j+="  </div>";j+="</div>";j+="</div>";$("#"+f).html(j);var q=window.innerWidth,m=window.innerHeight;if(g.width.toString().indexOf("%")!==-1){q=q*(g.width).substr(0,g.width.toString().indexOf("%"))/100-20}else{q=g.width}if(g.height.toString().indexOf("%")!==-1){m=m*(g.height).substr(0,g.height.toString().indexOf("%"))/100-20}else{m=g.height}$("#"+p+"viewer").width(q).height(m);$("#"+p+"canvas").width(q).height(m);if(parseInt(q)<=200){$("#"+p+"toolbox").hide()}$(".bottomTab").click(function(x){var w=$(".insideTab").height();if(w===0){$(".insideTab").height(200)}else{$(".insideTab").height(0)}});var n=new iCn3D(p+"canvas");if(g.bCalphaOnly!==undefined){n.bCalphaOnly=g.bCalphaOnly}var c={};c.camera="perspective";c.background="black";c.color="spectrum";c.sidechains="nothing";c.secondary="ribbon";c.surface="nothing";c.opacity="0.8";c.wireframe="no";c.ligands="stick";c.water="nothing";c.ions="sphere";c.hbonds="no";c.labels="no";c.lines="no";c.rotationcenter="molecule center";c.axis="no";c.picking="residue";c.nucleotides="phosphorus trace";c.surfaceregion="nothing";if(g.cid!==undefined){c.picking="atom"}n.cloneHash(c,n.options);k();function k(){if(g.pdbid!==undefined){var z=document.location.protocol;var w=g.pdbid.toLowerCase();if(z==="http:"){v(w)}else{if(z==="https:"){o(w)}}}else{if(g.mmdbid!==undefined){o(g.mmdbid)}else{if(g.gi!==undefined){var y;var x="//eutils.ncbi.nlm.nih.gov/entrez/eutils/elink.fcgi?dbfrom=protein&db=structure&linkname=protein_structure&id="+g.gi;$.ajax({url:x,dataType:"text",cache:true,success:function(B){if(B.indexOf("<Link>")===-1){alert("There are no MMDB IDs available for the gi "+g.gi)}else{var D=B.substr(B.indexOf("<Link>"));var E=D.indexOf("<Id>");var A=D.indexOf("</Id>");var C=D.substr(E+4,A-E-4);o(C)}}})}else{if(g.cid!==undefined){i(g.cid)}else{if(g.mmcif!==undefined){u(g.mmcif)}else{if(g.align!==undefined){a(g.align)}else{alert("Please input a gi, MMDB ID, PDB ID, CID, or mmCIF...")}}}}}}}function v(w){var x="//www.ncbi.nlm.nih.gov/Structure/mmcifparser/mmcifparser.cgi?pdbid="+w;n.bCid=undefined;var z="Molecule";var y="Chain";$.ajax({url:x,dataType:"text",cache:true,beforeSend:function(){$("#"+p+"wait").show();$("#"+p+"canvas").hide()},complete:function(){$("#"+p+"wait").hide();$("#"+p+"canvas").show()},success:function(A){n.loadPDB(A);n.inputid.idtype="pdbid";n.inputid.id=w;n.setAtomStyleByOptions(c);n.setColorByOptions(c,n.atoms);n.draw(c);if(g.rotate!==undefined&&g.rotate){h("right")}}})}function h(w){if(n.bStopRotate){return false}if(w==="left"){n.rotateLeft(5)}else{if(w==="right"){n.rotateRight(5)}else{if(w==="up"){n.rotateUp(5)}else{if(w==="down"){n.rotateDown(5)}else{return false}}}}setTimeout(function(){h(w)},1000)}function u(x){var w="//www.ncbi.nlm.nih.gov/Structure/mmcifparser/mmcifparser.cgi?mmcif="+x;n.bCid=undefined;$.ajax({url:w,dataType:"jsonp",cache:true,beforeSend:function(){$("#"+p+"wait").show();$("#"+p+"canvas").hide();$("#"+p+"log").hide()},complete:function(){$("#"+p+"wait").hide();$("#"+p+"canvas").show();$("#"+p+"log").show()},success:function(y){if(y.atoms!==undefined){l(y,y.mmcif,"mmcif");n.inputid.idtype="mmcif";n.inputid.id=x;n.setAtomStyleByOptions(c);n.setColorByOptions(c,n.atoms);n.draw(c);if(g.rotate!==undefined&&g.rotate){h("right")}}else{alert("invalid atoms data.");return false}}})}function a(B){var w="//www.ncbi.nlm.nih.gov/Structure/vastpp/vastpp.cgi?cmd=c&w3d&ids="+B;var z="//www.ncbi.nlm.nih.gov/Structure/vastpp/vastpp.cgi?cmd=c1&d&ids="+B;if(g.inpara!==undefined){w+=g.inpara;z+=g.inpara}n.bCid=undefined;n.pdbid_chain2title={};var x=$.ajax({url:z,dataType:"jsonp",cache:true,beforeSend:function(){$("#"+p+"wait").show();$("#"+p+"canvas").hide()},complete:function(){$("#"+p+"wait").hide();$("#"+p+"canvas").show()}});var A;var y=x.then(function(H){A=H.seqalign;var F=0;for(var I in H){if(F<2){var D=H[I].pdbid;var C=H[I].molecule;for(var E in C){var G=C[E].chain;n.pdbid_chain2title[D+"_"+G]=C[E].name}}++F}return $.ajax({url:w,dataType:"jsonp",cache:true,beforeSend:function(){$("#"+p+"wait").show();$("#"+p+"canvas").hide()},complete:function(){$("#"+p+"wait").hide();$("#"+p+"canvas").show()}})});y.done(function(C){if(C.atoms!==undefined){l(C,undefined,"align",A);n.inputid.idtype="alignment";n.inputid.id=B;n.setAtomStyleByOptions(c);n.setColorByOptions(c,n.atoms,true);n.draw(c);if(g.rotate!==undefined&&g.rotate){h("right")}}else{alert("invalid atoms data.");return false}})}function i(x){var w="//pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/"+x+"/SDF?record_type=3d";n.bCid=true;$.ajax({url:w,dataType:"text",cache:true,beforeSend:function(){$("#"+p+"wait").show();$("#"+p+"canvas").hide();$("#"+p+"log").hide()},complete:function(){$("#"+p+"wait").hide();$("#"+p+"canvas").show();$("#"+p+"log").show()},success:function(z){var y=r(z);if(!y){alert("The SDF of CID "+x+" has the wrong format...")}else{n.inputid.idtype="cid";n.inputid.id=x;n.setAtomStyleByOptions(c);n.setColorByOptions(c,n.atoms);n.draw(c);if(g.rotate!==undefined&&g.rotate){h("right")}}}}).fail(function(){alert("This CID may not have 3D structure...")})}function r(ac){var w=ac.split("\n");if(w.length<4){return false}n.init();var ad="1";var S="1";var Y="1";var T="LIG";var R=ad;var L=ad+"_"+S;var Q=L+"_"+Y;var ab=parseInt(w[3].substr(0,3));if(isNaN(ab)||ab<=0){return false}var G=parseInt(w[3].substr(3,3));var H=4;if(w.length<H+ab+G){return false}var F=0;var D=ab;var Z,P;var C={};for(Z=F;Z<D;Z++){P=w[H];H++;var E=Z;var O=parseFloat(P.substr(0,10));var M=parseFloat(P.substr(10,10));var K=parseFloat(P.substr(20,10));var U=new THREE.Vector3(O,M,K);var ae=P.substr(31,3).replace(/ /g,"");var J={het:true,serial:E,name:ae,resn:T,structure:ad,chain:S,resi:Y,coord:U,b:0,elem:ae,bonds:[],ss:"coil",ssbegin:false,ssend:false,bondOrder:[]};n.atoms[E]=J;C[E]=1}n.displayAtoms=C;n.highlightAtoms=C;n.structures[R]=C;n.chains[L]=C;n.residues[Q]=C;n.residueId2Name[Q]=T;if(n.chainsSeq[L]===undefined){n.chainsSeq[L]=[]}if(n.chainsAnno[L]===undefined){n.chainsAnno[L]=[]}if(n.chainsAnno[L][0]===undefined){n.chainsAnno[L][0]=[]}n.chainsSeq[L].push(T);n.chainsAnno[L][0].push(Y);for(Z=0;Z<G;Z++){P=w[H];H++;var V=parseInt(P.substr(0,3))-1+F;var B=parseInt(P.substr(3,3))-1+F;var X=parseInt(P.substr(6,3));n.atoms[V].bonds.push(B);n.atoms[V].bondOrder.push(X);n.atoms[B].bonds.push(V);n.atoms[B].bondOrder.push(X)}var I=new THREE.Vector3(9999,9999,9999);var N=new THREE.Vector3(-9999,-9999,-9999);var aa=new THREE.Vector3();var W=0;for(var Z in n.atoms){var A=n.atoms[Z];var U=A.coord;aa.add(U);I.min(U);N.max(U);++W;if(A.het){if($.inArray(A.elem,n.ionsArray)!==-1){n.ions[A.serial]=1}else{n.ligands[A.serial]=1}}}n.pmin=I;n.pmax=N;n.cnt=W;n.maxD=n.pmax.distanceTo(n.pmin);n.center=aa.multiplyScalar(1/n.cnt);if(n.maxD<25){n.maxD=25}return true}function o(x){var w="//www.ncbi.nlm.nih.gov/Structure/mmdb/mmdb_strview.cgi?program=w3d&uid="+x;n.bCid=undefined;if(g.inpara!==undefined){w+=g.inpara}$.ajax({url:w,dataType:"jsonp",cache:true,beforeSend:function(){$("#"+p+"wait").show();$("#"+p+"canvas").hide()},complete:function(){$("#"+p+"wait").hide();$("#"+p+"canvas").show()},success:function(ae){if((g.inpara!==undefined&&g.inpara.indexOf("mols=")!=-1)||(ae.atomcount<=ae.threshold&&ae.atoms!==undefined)){var T=(ae.pdbId!==undefined)?ae.pdbId:ae.mmdbId;l(ae,T,"mmdbid");n.inputid.idtype="mmdbid";n.inputid.id=T;n.setAtomStyleByOptions(c);n.setColorByOptions(c,n.atoms,true);n.draw(c);if(g.rotate!==undefined&&g.rotate){h("right")}}if(g.inpara!==undefined&&g.inpara.indexOf("mols=")==-1&&ae.atomcount>ae.threshold&&ae.molid2rescount!==undefined){var Q=40;n.bSSOnly=true;var T=(ae.pdbId!==undefined)?ae.pdbId:ae.mmdbId;l(ae,T,"mmdbid");n.inputid.idtype="mmdbid";n.inputid.id=T;c.nucleotides="phosphorus lines";n.setAtomStyleByOptions(c);n.setColorByOptions(c,n.atoms,true);var W=ae.molid2rescount;var L={},H={},Y={};var O="<table width='100%'><tr><td></td><th>#</th><th align='center'>Chain</th><th align='center'>Residue Count</th></tr>";var S=1;for(var aa in W){var N="#"+("000000"+W[aa].color.toString(16)).slice(-6);O+="<tr style='color:"+N+"'><td><input type='checkbox' name='"+p+"filter_ckbx' value='"+aa+"'/></td><td align='center'>"+S+"</td><td align='center'>"+W[aa].chain+"</td><td align='center'>"+W[aa].resCount+"</td></tr>";L[aa]=N;var af=T+"_"+W[aa].chain;H[af]=aa;Y[aa]=af;++S}if(Object.keys(n.ligands).length>0){O+="<tr><td><input type='checkbox' name='"+p+"filter_ckbx' value='ligands'/></td><td align='center'>"+S+"</td><td align='center'>Ligands</td><td align='center'>"+Object.keys(n.ligands).length+" atoms</td></tr>"}O+="</table>";var C={};for(var aa in n.chains){var X={};var V=n.centerAtoms(n.hash2Atoms(n.chains[aa]));X.position=V;var af=aa.substr(aa.indexOf("_")+1);X.text=af;X.size=Q;X.color=L[H[aa]];X.background="#FFFFFF";C[H[aa]]=X}molid2ss={};for(var aa in ae.helix){for(var Z=0,D=ae.helix[aa].length;Z<D;++Z){var ah=ae.helix[aa][Z];var U={};U.type="helix";U.startResi=ah.from;U.endResi=ah.to;U.coords=[];U.coords.push(ah.end);U.coords.push(ah.start);if(molid2ss[aa]===undefined){molid2ss[aa]=[]}molid2ss[aa].push(U)}}for(var aa in ae.brick){for(var Z=0,D=ae.brick[aa].length;Z<D;++Z){var I=ae.brick[aa][Z];var U={};U.type="brick";U.startResi=I.from;U.endResi=I.to;U.coords=[];var M={},F={},B={};M.x=0.25*(I["000"][0]+I["010"][0]+I["011"][0]+I["001"][0]);M.y=0.25*(I["000"][1]+I["010"][1]+I["011"][1]+I["001"][1]);M.z=0.25*(I["000"][2]+I["010"][2]+I["011"][2]+I["001"][2]);F.x=0.25*(I["100"][0]+I["110"][0]+I["111"][0]+I["101"][0]);F.y=0.25*(I["100"][1]+I["110"][1]+I["111"][1]+I["101"][1]);F.z=0.25*(I["100"][2]+I["110"][2]+I["111"][2]+I["101"][2]);B.x=I["010"][0]-I["000"][0];B.y=I["010"][1]-I["000"][1];B.z=I["010"][2]-I["000"][2];U.coords.push(M);U.coords.push(F);U.coords.push(B);if(molid2ss[aa]===undefined){molid2ss[aa]=[]}molid2ss[aa].push(U)}}for(var aa in molid2ss){molid2ss[aa].sort(function(aj,ai){return parseFloat(aj.startResi)-parseFloat(ai.startResi)})}if(n.cnt!==0){var ad=n.pmin;var K=n.pmax;var E=n.center.multiplyScalar(n.cnt);var J=n.cnt}else{var ad=new THREE.Vector3(9999,9999,9999);var K=new THREE.Vector3(-9999,-9999,-9999);var E=new THREE.Vector3();var J=0}for(var aa in molid2ss){var ag=new THREE.Vector3(9999,9999,9999);var A=new THREE.Vector3(-9999,-9999,-9999);var ac=new THREE.Vector3();var P=0;for(var Z=0,D=molid2ss[aa].length;Z<D;++Z){var G=molid2ss[aa][Z].coords[0];ad.min(G);K.max(G);E.add(G);ag.min(G);A.max(G);ac.add(G);++J;++P;G=molid2ss[aa][Z].coords[1];ad.min(G);K.max(G);E.add(G);ag.min(G);A.max(G);ac.add(G);++J;++P}var ab=ac.multiplyScalar(1/P);var X={};var V=new THREE.Vector3();V.x=ab.x;V.y=ab.y;V.z=ab.z;X.position=V;var af=Y[aa];X.text=af.substr(af.indexOf("_")+1);X.size=Q;X.color=L[aa];X.background="#FFFFFF";C[aa]=X}n.maxD=K.distanceTo(ad);n.center=E.multiplyScalar(1/J);for(var aa in molid2ss){for(var Z=1,D=molid2ss[aa].length;Z<D;++Z){var U={};U.type="coil";U.startResi=molid2ss[aa][Z-1].endResi;U.endResi=molid2ss[aa][Z].startResi;U.coords=[];U.coords.push(molid2ss[aa][Z-1].coords[1]);U.coords.push(molid2ss[aa][Z].coords[0]);molid2ss[aa].push(U)}}n.savedLabels=C;n.molid2ss=molid2ss;n.molid2color=L;n.draw(c);if(g.rotate!==undefined&&g.rotate){h("right")}$("#"+p+"dl_filter_table").html(O);var R="Select chains to display";var y=250,z=(/Mac/i.test(navigator.userAgent)&&!/iPhone|iPad|iPod/i.test(navigator.userAgent))?"auto":200;var V={my:"left top",at:"left+10 top+93",of:"#"+p+"canvas",collision:"none"};window.dialog=$("#"+p+"dl_filter").dialog({autoOpen:true,title:R,height:z,width:y,modal:false,position:V});$(".ui-dialog .ui-button span").removeClass("ui-icon-closethick").addClass("ui-icon-close")}if(ae.atoms===undefined&&ae.molid2rescount===undefined){alert("invalid MMDB data.");return false}}})}function l(ar,Z,au,M){n.init();var aq=new THREE.Vector3(9999,9999,9999);var O=new THREE.Vector3(-9999,-9999,-9999);var G=new THREE.Vector3();var P=ar.atoms;var U=0;var C=0;var F={};var ag={};if(au==="align"){for(var am=0,W=ar.aligned_structures.length;am<W;++am){var R=ar.aligned_structures[am];for(var aj=R.range[0];aj<=R.range[1];++aj){var N=R.pdbid;var Y=R.mmdbid;F[aj]=N.toString();ag[Y]=N}}}var ah={};var w={};if(au==="mmdbid"||au==="align"){if(au==="mmdbid"){if(ar.molid2chain!==undefined){for(var ap in ar.molid2chain){ah[ap]=ar.molid2chain[ap].chain}}}else{if(au==="align"){if(ar.molid2chain!==undefined){for(var ae in ar.molid2chain){for(var ap in ar.molid2chain[ae]){w[ag[ae]+"_"+ap]=ar.molid2chain[ae][ap].chain}}}}}}var af={};for(var am in P){++U;af[am]=U;var ab=P[am];ab.serial=U;var y;if(au==="mmdbid"||au==="mmcif"){y=Z}else{if(au==="align"){y=F[U]}}if(ab.chain===undefined&&(au==="mmdbid"||au==="align")){if(au==="mmdbid"){var ap=ab.ids.m;ab.chain=(ah[ap]===undefined)?"?":ah[ap]}else{if(au==="align"){var ap=ab.ids.m;ab.chain=(w[y+"_"+ap]===undefined)?"?":w[y+"_"+ap]}}}else{ab.chain=(ab.chain==="")?"?":ab.chain}ab.resi=parseInt(ab.resi);if(ab.color!==undefined){ab.color=new THREE.Color(ab.color)}ab.coord=new THREE.Vector3(ab.coord.x,ab.coord.y,ab.coord.z);if(au==="mmdbid"||au==="align"){ab.structure=y}aq.min(ab.coord);O.max(ab.coord);G.add(ab.coord);if(ab.mt==="p"||ab.mt==="n"){if(ab.mt==="p"){n.peptides[U]=1;if(ab.name==="CA"){n.calphas[U]=1}}else{if(ab.mt==="n"){n.nucleotides[U]=1;if(ab.name=="P"){n.nucleotidesP[U]=1}}}n.het=false}else{if(ab.mt==="s"){n.water[U]=1;n.het=true}else{if(ab.mt==="l"){n.ligands[U]=1;if(ab.bonds.length===0){n.ions[U]=1}n.het=true}}}if(ab.resn=="HOH"){n.water[U]=1}n.atoms[U]=ab;n.displayAtoms[U]=1;n.highlightAtoms[U]=1;if(n.structures[y]===undefined){n.structures[y]={}}n.structures[y][U]=1;var L=ab.structure+"_"+ab.chain;if(n.chains[L]===undefined){n.chains[L]={}}n.chains[L][U]=1;var V=ab.structure+"_"+ab.chain+"_"+ab.resi;if(n.residues[V]===undefined){n.residues[V]={}}n.residues[V][U]=1;var aa=n.residueName2Abbr(ab.resn.substr(0,3));n.residueId2Name[V]=aa;if(ab.resi!=C){if(n.chainsSeq[L]===undefined){n.chainsSeq[L]=[]}if(n.chainsAnno[L]===undefined){n.chainsAnno[L]=[]}if(n.chainsAnno[L][0]===undefined){n.chainsAnno[L][0]=[]}if(n.chainsAnnoTitle[L]===undefined){n.chainsAnnoTitle[L]=[]}if(n.chainsAnnoTitle[L][0]===undefined){n.chainsAnnoTitle[L][0]=[]}n.chainsSeq[L].push(aa);n.chainsAnno[L][0].push(ab.resi);n.chainsAnnoTitle[L][0].push("");if(au==="mmdbid"||au==="align"){n.chainsColor[L]=ab.color}}C=ab.resi}if(au!=="mmcif"){for(var am in n.atoms){var J=(n.atoms[am].bonds===undefined)?0:n.atoms[am].bonds.length;for(var aj=0;aj<J;++aj){n.atoms[am].bonds[aj]=af[n.atoms[am].bonds[aj]]}}}n.cnt=U;n.pmin=aq;n.pmax=O;n.maxD=O.distanceTo(aq);n.center=G.multiplyScalar(1/n.cnt);if(n.maxD<25){n.maxD=25}if(au==="align"&&M!==undefined){for(var am=0,W=M.length;am<W;++am){var an=M[am][0];var z=ar.aligned_structures[0].pdbid;var ao=an.mid;var ak=w[z+"_"+ao];var B=z+"_"+ak;var X={};var S=an.mseq.length,I=-1;for(var aj=0,E=an.mseq.length;aj<E;++aj){var Q=an.mseq[aj][1];var K=(an.mseq[aj][2]==="~")?"-":an.mseq[aj][2];var ad=an.mseq[aj][3];if(ad==1){if(aj<S){S=aj}if(aj>I){I=aj}}X[aj]={resi:Q,resn:K,aligned:ad}}an=M[am][1];var x=ar.aligned_structures[1].pdbid;var al=an.sid;var ai=w[x+"_"+al];var A=x+"_"+ai;if(n.alignChainsAnnoTitle[B]===undefined){n.alignChainsAnnoTitle[B]=[]}if(n.alignChainsAnnoTitle[B][0]===undefined){n.alignChainsAnnoTitle[B][0]=[]}if(n.alignChainsAnnoTitle[B][1]===undefined){n.alignChainsAnnoTitle[B][1]=[]}if(n.alignChainsAnnoTitle[B][2]===undefined){n.alignChainsAnnoTitle[B][2]=[]}if(n.alignChainsAnnoTitle[B][3]===undefined){n.alignChainsAnnoTitle[B][3]=[]}if(n.alignChainsAnnoTitle[B][4]===undefined){n.alignChainsAnnoTitle[B][4]=[]}if(n.alignChainsAnnoTitle[B][5]===undefined){n.alignChainsAnnoTitle[B][5]=[]}n.chainsAnnoTitle[B][0].push("");n.alignChainsAnnoTitle[B][0].push("");n.alignChainsAnnoTitle[B][1].push("");n.alignChainsAnnoTitle[B][2].push("");n.alignChainsAnnoTitle[B][3].push(A);n.alignChainsAnnoTitle[B][4].push(B);n.alignChainsAnnoTitle[B][5].push("");var ac=1;for(var aj=S;aj<=I;++aj){var Q=an.sseq[aj][1];var K=(an.sseq[aj][2]==="~")?"-":an.sseq[aj][2];var ad=X[aj].aligned+an.sseq[aj][3];var T;if(ad===2){if(X[aj].resn===K){T="#F00"}else{T="#00F"}}else{T="#CCC"}if(n.alignChainsSeq[B]===undefined){n.alignChainsSeq[B]=[]}var at={};at.mmdbid=z;at.chain=ak;at.resi=X[aj].resi;at.resn=X[aj].resn;at.aligned=ad;at.color=T;n.alignChainsSeq[B].push(at);if(!isNaN(X[aj].resi)){if(n.alignChains[B]===undefined){n.alignChains[B]={}}$.extend(n.alignChains[B],n.residues[B+"_"+X[aj].resi])}if(n.alignChainsSeq[A]===undefined){n.alignChainsSeq[A]=[]}at={};at.mmdbid=x;at.chain=ai;at.resi=Q;at.resn=K;at.aligned=ad;at.color=T;n.alignChainsSeq[A].push(at);if(!isNaN(Q)){if(n.alignChains[A]===undefined){n.alignChains[A]={}}$.extend(n.alignChains[A],n.residues[A+"_"+Q])}if(n.alignChainsAnno[B]===undefined){n.alignChainsAnno[B]=[]}if(n.alignChainsAnno[B][0]===undefined){n.alignChainsAnno[B][0]=[]}if(n.alignChainsAnno[B][1]===undefined){n.alignChainsAnno[B][1]=[]}if(aj===S){if(n.alignChainsAnno[B][2]===undefined){n.alignChainsAnno[B][2]=[]}if(n.alignChainsAnno[B][3]===undefined){n.alignChainsAnno[B][3]=[]}if(n.alignChainsAnno[B][4]===undefined){n.alignChainsAnno[B][4]=[]}if(n.alignChainsAnno[B][5]===undefined){n.alignChainsAnno[B][5]=[]}n.alignChainsAnno[B][2].push("");n.alignChainsAnno[B][3].push(n.pdbid_chain2title[A]);n.alignChainsAnno[B][4].push(n.pdbid_chain2title[B]);n.alignChainsAnno[B][5].push("")}var D=".";if(ac%5===0){D="*"}if(ac%10===0){D="|"}n.alignChainsAnno[B][0].push(D);var H="";if(ac%10===0){H=ac.toString()}n.alignChainsAnno[B][1].push(H);++ac}}}}function t(){for(var w in n.atoms){n.highlightAtoms[w]=1}}function b(y,w){var x={};x[y]=w;t();n.setColorByOptions(x,n.atoms);n.draw(x)}function e(z,y){var w={};t();switch(z){case"secondary":w=n.intersectHash(n.highlightAtoms,n.peptides);break;case"sidechains":w=n.intersectHash(n.highlightAtoms,n.peptides);break;case"nucleotides":w=n.intersectHash(n.highlightAtoms,n.nucleotides);break;case"ligands":w=n.intersectHash(n.highlightAtoms,n.ligands);break;case"ions":w=n.intersectHash(n.highlightAtoms,n.ions);break;case"water":w=n.intersectHash(n.highlightAtoms,n.water);break}for(var x in w){n.atoms[x].style=y}n.draw(c)}$(".enablepick").click(function(w){w.preventDefault();if(g.cid!==undefined){n.picking=1;n.options.picking="atom"}else{n.picking=2;n.options.picking="residue"}});$(".disablepick").click(function(w){w.preventDefault();n.picking=0;n.options.picking="no";n.draw(undefined,undefined,false);n.removeHighlightObjects()});$("#"+p+"reset").click(function(w){w.preventDefault();k()});$("#"+p+"filter_ckbx_all").click(function(z){var w=document.getElementsByName(p+"filter_ckbx");if($(this)[0].checked==true){for(var y=0,x=w.length;y<x;++y){w[y].checked=true}}else{for(var y=0,x=w.length;y<x;++y){w[y].checked=false}}});$("#"+p+"filter").click(function(C){C.preventDefault();var x=document.getElementsByName(p+"filter_ckbx");var w="";var B="&het=0";for(var A=0,y=x.length;A<y;++A){if(x[A].checked){if(x[A].value=="ligands"){B="&het=2"}else{w+=x[A].value+","}}}if(w==""){w=x[0].value}var z=document.URL+"&mols="+w+"&complexity=2"+B;window.open(z,"_self")});$("#"+p+"label_3d_diagram").click(function(A){var x=document.getElementsByName(p+"filter_ckbx");var w="";var B=[];for(var z=0,y=x.length;z<y;++z){if(x[z].checked){if(x[z].value!="ligands"){B.push(n.savedLabels[x[z].value])}}}n.labels=B;n.createLabelRepresentation(n.labels);n.render()});if(g.resize!==undefined&&g.resize&&!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){$(window).resize(function(){if(g.resize!==undefined&&g.resize){$("#"+p+"canvas").width($(window).width()-20).height($(window).height()-20);$("#"+p+"viewer").width($(window).width()-20).height($(window).height()-20);n.setWidthHeight($(window).width()-20,$(window).height()-20);n.draw(c)}})}["color","sidechains","secondary","ligands","water","ions","nucleotides"].forEach(function(w){$("#"+p+w).change(function(x){if(w==="color"){b(w,$("#"+p+w).val())}else{e(w,$("#"+p+w).val())}})})};