<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <!-- Docs: http://www.ncbi.nlm.nih.gov/tools/sviewer/embedding-api/ -->
    <script type="text/javascript" src="http://www.ncbi.nlm.nih.gov/core/jquery/jquery-1.7.2.js"></script>
    <script type="text/javascript" src="http://www.ncbi.nlm.nih.gov/projects/sviewer/js/sviewer.js" id="autoload"></script>
  </head>
  <body>
    <div id="sv1" class="SeqViewerApp">
      <!-- gi 27894321 correponding to the PDB ID 2ROX -->
      <a href="?embedded=true&id=27894321&url=http://testpubchem.ncbi.nlm.nih.gov/wangjiy/icn3d2/27894321.bed"></a>
    </div>

    <script>
    	jQuery(function() {
	    SeqViewOnReady(function() {
			// Hack the function checkJobStatus to get the gi, start position, and length
			//   so that we can use the information to generate a link to the 3D viewer iCn3D
			SeqView.Selection.prototype.x_checkJobStatus = SeqView.Selection.prototype.checkJobStatus;
			SeqView.Selection.prototype.checkJobStatus = function(data, sel_tooltip, area) {
				var obj = data[0];
				var start_pos = Number(obj.text.match(/Location:.+?>(\d+)</)[1]);
				var length = Number(obj.text.match(/Length:.+?>(\d+)</)[1]);
				var localGi = Number(obj.text.match(/region:.+?>(\d+)</)[1]);
				var end_pos = start_pos + length - 1;
				var obj_position = start_pos + '-' + end_pos;

				var fn = function(linksList) {
					// a link to the 3D viewer iCN3D
					var link = {"type":"Basic","name":"View in 3D Structure","links":[{"label":"iCn3D","link":"http://testpubchem.ncbi.nlm.nih.gov//wangjiy/icn3d2/icn3d_embed.html?gi=" + localGi + "&command=color grey; select :" + obj_position + " | name residue" + obj_position + " | description test; color red; select aroundsphere | radius 5; color blue"}]};
					linksList.push(link);
				};

				// add the link through the function setTooltipPreprocessor
				var app = SeqView.App.findAppByDivId('sv1');
				app.setTooltipPreprocessor(fn);

				// call the hacked function checkJobStatus
				this.x_checkJobStatus(data, sel_tooltip, area);
				app.setTooltipPreprocessor();
			};
	    });
	    });
    </script>
  </body>
</html>

